\chapter{Device Topology}

Device Topology is representation of videoconferencing devices from various 
technologies and its' mutual reachability in a single domain. Each domain 
controller in Shongo will keep in memory the local topology of all devices 
which the controller manages and which are part of controller reservations 
(unmanaged or foreign devices but only as single nodes without theirs 
topology).
Controller will not know topologies from foreign domains. Every time when the 
controller needs some information about foreign devices it send request to 
foreign domain controller.

Device Topology is composed of nodes and edges. Nodes represents 
videoconference devices and edges theirs reachability in a specific technology 
(e.g., ability to communicate in H.323). The reachability is determined by 
devices' capabilities and by list of global rules which defines the additional 
constraints.

\section{Node}

Each node in Device Topology represents one videoconference device. Device is 
able to communicate with one or more \textbf{technologies} (H.323, SIP, Adobe 
Connect, etc.).
\\
Device can have one or more \textbf{capabilities}. Each capability can specify 
one or more device \textbf{technologies} to which it is provided. Capabilities 
can be from the following types:

\begin{itemize}
\newcommand{\RequireCapability}[1]{(requires #1)}
\newcommand{\ExtendCapability}[1]{(extends #1)}

\item \textbf{Standalone Terminal} \\
  Capability tells that device is a terminal that is able to communicate to
  other standalone terminal directly without \textbf{Mixing} or 
  \textbf{Virtual 
  Rooming} device (e.g., H.323 and SIP terminals are generally standalone 
  terminal devices but Adobe Connect client is not standalone device because 
  it always needs the Adobe Connect server to start a videoconference).
  
\item \textbf{Receive}/\textbf{Send} \\
  Capability allows for receiving/sending through a limited (or unlimited) 
  number of the \textbf{input}/\textbf{output channels}. Each channel must 
  contain at least one of the following \textbf{streams}:
  \begin{itemize}
    \item \textbf{audio} in a specific \textbf{audio codecs} and 
      \textbf{bitrates}.
    \item \textbf{video} in a specific \textbf{video codecs} and 
      \textbf{resolutions}.
    \item \textbf{content} in a specific \textbf{content formats}.
  \end{itemize} 
  
\item \textbf{Mix} \RequireCapability{\textbf{Receive} and \textbf{Send}} \\
  Capability allows for mixing of multiple input channels and send 
  the combined result through one output channel. To each input channel can be 
  connected one other device (each other device sends different data -- 
  unicast). To each output channel can be connected multiple other devices 
  (each other device want to receive the same data -- multicast).

\item \textbf{Virtual Rooming} \ExtendCapability{\textbf{Mix}} \\
  Capability allows the device to divide input channels into groups (virtual 
  rooms). \textbf{Mixing} is applied per group and each group 
  is bound to one output channel. Maximum number of output channels thus 
  defines the maximum number of virtual rooms. For each virtual room there can 
  be specified the maximum number of input channels (maximum videoconference 
  participants).

\item \textbf{Signaling Client} \\
  Capability makes the device to have set an alias 
  and an address of a signaling server to which it registers itself.
  The devices that are registered to the same signaling server are by
  default reachable by an alias. This behavior can be changed by global rules. 
  Also the global rules are able to make reachable devices registered to 
  different signaling servers.

\item \textbf{Signaling Server} \\
  Capability tells that the device is signaling server
  that has registry of devices and its' aliases and make that devices by 
  default reachable. Signaling servers can have set maximum number of 
  connections that may be established through the server by aliases.

\item \textbf{Translate} \RequireCapability{\textbf{Receive} and \textbf{Send} 
  and at least 2 \textbf{technologies}} \\
  Capability allows for translation from one input channel to another output 
  channel where the first channel is from one specified technology and the 
  second is from another specified technology. By default all translations 
  from input to output channels are allowed. The list of \textbf{rules} can be 
  used to restrict the allowed translations (e.g., for specific codecs, 
  resolutions, etc.).

\item \textbf{Stream} \RequireCapability{\textbf{Receive}} \\
  Capability tells that the device is able to perform streaming from an input 
  channel.

\item \textbf{Record} \RequireCapability{\textbf{Receive}} \\
  Capability tells that the device is able to perform recording from an input 
  channel.
  
\item \TODO{Do we have Managed/Unmanaged capability?}
 \\ \TODO{Managed capability would have Connector address attribute.}
 \\ \TODO{Unmanaged capability would have contact (e.g., email) to which
 are send reservations calendars.}
\end{itemize}

Each device can have one or more described capabilities. If device supports 
for instance receiving/sending in multiple technologies, it can be implemented 
by multiple capability of the same type (one for each technology) or by single 
capability that lists all the technologies (provided that all technologies has 
same \textbf{channels} settings).

\subsection*{Examples of abstract devices (each with technology dependent 
             examples):}

\lstnewenvironment{TopologyExample}[2]{%
    \vspace{2mm}
    \UseCodeStyle{
      StandaloneTerminal, Receive, Send, Mix, VirtualRooming, 
      SignalingServer, SignalingClient, Translate,
      SIP, H323, AdobeConnect, H264, CIF, 720p, Address, Alias, Enable, 
      Disable
    }     
    \minipage{\textwidth}
    \advance\leftmargini -3mm \quote
    \footnotesize\ttfamily \textbf{#1} = \{
    \ifx&#2& \else {\color{gray}// #2} \fi
}{%
    \vspace*{-4pt}
    \footnotesize\ttfamily \}
    \endquote
    \endminipage
}

\begin{itemize}

\item \textbf{Terminal device} \\
  Terminal device is hardware or software client that is used by an user to 
  connect to a videoconference. The device allow an user to participate only 
  in one videoconference at the time thus it has \textbf{Receive} and 
  \textbf{Send} capability but limited to 1 channel. It can have also the 
  \textbf{Standalone Terminal} capability which allows the terminal devices to  
  establish also 2-point videoconferences. 
  
\begin{TopologyExample}{terminal1}{Example of terminal for H.323 and/or SIP}
technology: [H323, SIP],
capability: [
  {type: StandaloneTerminal, technology: *},
  {type: Receive, channel: {count: 1}}, // "technology: *" is by default
  {type: Send, channel: {count: 1}}
]
\end{TopologyExample}

\begin{TopologyExample}{terminal2}
      {Example of terminal (client) for Adobe Connect}
technology: AdobeConnect,
capability: [
  {type: [Receive, Send], channel: {count: 1}},
]
\end{TopologyExample}

\begin{TopologyExample}{terminal3}{Example of H323 terminal}
// It can process arbitrary audio, but video only in H.264 (CIF -- 720p)
// It cannot process content
technology: H323,
capability: [
  {type: [Receive, Send], channel: {
    count: 1, 
    stream: {
      audio: *,
      video: {codec: H264, resolution: [CIF..720p]}
    }  
  }}
]
\end{TopologyExample}

\item \textbf{Terminal device with virtual room} \\
  Terminal device with a single embedded virtual room is extension of terminal 
  device that allows user to host a single multipoint videoconference. The 
  device has \textbf{Receive} capability with limited number of input channels 
  to number of allowed participants in the provided single virtual room. It 
  also has \textbf{Send} capability but limited to 1 channel. The last 
  provided capability is \textbf{Mix} which combines input channels to a 
  single output channel and through it mediates the multipoint 
  videoconference. It is worth to note that the terminal device with embedded 
  virtual room itself is part of 
  the hosted videoconference.
  
\begin{TopologyExample}{terminal4}
      {Example of terminal with one virtual room 
for H.323 and/or SIP}
technology: [H323, SIP],
capability: [
  {type: Receive, channel: {count: 9}}, // max 9 other participants
  {type: Send, channel: {count: 1}},
  {type: Mix}
]
\end{TopologyExample}

\item \textbf{Multipoint device} \\
  Multipoint device is a special type of device that hosts one or more virtual 
  rooms and an arbitrary device can connect to a hosted virtual room and take 
  a videoconference there. The difference between multipoint and the previous 
  device is that the multipoint device can host more than one videoconference 
  and the multipoint device isn't part of these videoconferences, it only 
  manages them. The multipoint device has \textbf{Receive}, \textbf{Send}
  and \textbf{Virtual Rooming} capabilities. Number of input 
  channels for \textbf{Receive} capability is limited to a maximum number of 
  participants in all hosted videoconferences in the device. Number of output 
  channels for \textbf{Send} capability is limited to a maximum number of 
  virtual rooms (=~videoconferences) in the device. \textbf{Virtual Rooming} 
  capability provides the ability to mix input channels to one output channel 
  that is routed to all participants in each virtual room.

\begin{TopologyExample}{mcu1}{Example of H.323 and/or SIP multipoint device}
technology: [H323, SIP],
capability: [
  {type: Receive, channel: {count: 99}}, // max 99 participants
  {type: Send, channel: {count: 9}},     // max 9 virtual rooms
  {type: VirtualRooming}
]
\end{TopologyExample}

\begin{TopologyExample}{server1}{Example of Adobe Connect server}
technology: AdobeConnect,
capability: [
  {type: Receive, channel: {count: 99}}, // max 99 participants
  {type: Send, channel: {count: *}},     // unlimited virtual rooms
  {type: VirtualRooming}
]
\end{TopologyExample}

\item \textbf{Signaling server device} \\
  Signaling server device is a special type of device that has only 
  \textbf{Signaling Server} capability. All of previous device examples can 
  also have \textbf{Signaling Client} capability which allows other devices
  to address them by it's alias.
    
\begin{TopologyExample}{gatekeeper}{Example of gatekeeper for H.323}
technology: H323,
capability: [
  {type: SignalingServer, max-connection: 99}
]
\end{TopologyExample}

\begin{TopologyExample}{proxy}{Example of proxy for SIP}
technology: SIP,
capability: [
  {type: SignalingServer, max-connection: 55}
]
\end{TopologyExample}

\begin{TopologyExample}{mcu2}
      {Example of MCU that is registered to H.323 and SIP servers}
technology: [H323, SIP],
capability: [
  {type: [Send, Receive], channel: {count: 99}},
  {type: VirtualRooming, room: [room1, room2]},
  {type: SignalingClient, technology: H323, server: gatekeeper,
     alias: {room1: 9500000002, room2: 9500000003}},
  {type: SignalingClient, technology: SIP, server: proxy,
     alias: {room1: sip:room1@cesnet.cz}} // room2 is registered only to H.323
]
\end{TopologyExample}

\begin{TopologyExample}{terminal5}
      {Example of terminal that is registered to H.323 and SIP servers}
technology: [H323, SIP],
capability: [
  {type: [Send, Receive], channel: {count: 1}},
  {type: SignalingClient, technology: H323, server: gatekeeper,
     alias: 9500000001},
  {type: SignalingClient, technology: SIP, server: proxy,
     alias: sip:srom@cesnet.cz}
]
\end{TopologyExample}

\end{itemize}
 

\section{Edge}

The oriented edge is a link between two nodes and it tells that the second 
node (the node with incoming arrow) is reachable from the first node. A 
bidirectional edge tells that either node is reachable to the other node. 
Each edge is bound to a specific \textbf{technology} (e.g., H.323 or SIP) and 
to a specific \textbf{type} of connection in the technology (e.g., in H.323 
may be endpoints reachable by IP address or by H.323 alias, if both is 
available two edges must be present). Each edge also specifies number of 
\textbf{channels} that are available between the nodes (devices) and for each 
channel is specified set of \textbf{streams} that can be used.

\begin{TopologyExample}{proxy}{}
technology: SIP,
capability: [{type: SignalingServer}]
\end{TopologyExample}

\begin{TopologyExample}{terminal1}{}
address: 147.251.99.1,
technology: [H323, SIP],
capability: [
  {type: StandaloneTerminal},
  {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: SIP, server: proxy, alias: sip:1}
]
\end{TopologyExample}

\begin{TopologyExample}{terminal2}{}
address: 147.251.99.2,
technology: [H323, SIP],
capability: [
  {type: StandaloneTerminal},
  {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: SIP, server: proxy, alias: sip:2}
]
\end{TopologyExample}

\begin{TopologyExample}{edge1}{terminal1 <-> terminal2}
technology: H323,
type: Address,
channel: {count: 1}
\end{TopologyExample}

\begin{TopologyExample}{edge2}{terminal1 <-> terminal2}
technology: SIP,
type: Alias,
channel: {count: 1}
\end{TopologyExample} 
  
  
\section{Rule}
Rules in Device Topology are at global level and they are used for modifying 
the default reachability (determined by nodes capability settings). Each rule 
must specify a target \textbf{technology}, a \textbf{type} of connection in 
the technology (\verb|Address| or \verb|Alias|), nodes (or groups of nodes) 
to which the rule is applied and modifier (\verb|Enable| or \verb|Disable|) 
which tells whether the reachability will be enabled or disabled. The nodes 
can be specified by pattern for identifier, address or alias. If more than 
one group of nodes is specified then the rule is applied only for edges 
between the groups and not inside the groups.

\begin{TopologyExample}{rule1}
      {Disable reachability by IP address for all H.323 devices}
technology: H323,
type: Address,
node: *,
goal: Disable
\end{TopologyExample}

\begin{TopologyExample}{rule2}
      {Enable reachability by IP address for all H.323 devices at FI MUNI}
technology: H323,
type: Address,
node: cz.muni.fi.*,
goal: Enable
\end{TopologyExample}

\begin{TopologyExample}{rule3}{}
// Enable reachability by alias of SIP and H.323 devices between two networks.
// Devices from each network are referenced by the network gatekeeper.
technology: [H323, SIP],
type: Alias,
node: [gatekeeper1.*, gatekeeper2.*],
goal: Enable
\end{TopologyExample}

\begin{TopologyExample}{rule3}{Enable all correct reachability}
technology: *,
type: *,
node: *,
goal: Enable
\end{TopologyExample}


\section{Examples}

\subsection{Example of complex videoconference network}

The network (fig. \ref{graph:topology:example1}) is composed of two SIP user 
agents (\emph{userAgent1} and \emph{userAgent2}), two H.323 terminals 
(\emph{terminal1} and \emph{terminal2}), multipoint device (\emph{mcu}) that 
allows H.323 and SIP devices to connect to it's virtual rooms. User agents 
are configured to use SIP Proxy (\emph{proxy}) and terminals are configured 
to use H.323 gatekeeper (\emph{gatekeeper}). The \emph{mcu} is configured to 
use both SIP and H.323 signaling servers. The network also contains Adobe 
Connect server (\emph{server}) and two web clients that can connect to it 
(\emph{client1} and \emph{client2}). H.323 endpoints can connect to Adobe 
Connect server through special gateway device (\emph{gateway}). The SIP user 
agents can also connect to Adobe Connect server but only through the 
\emph{mcu}.

\begin{Graph}{graph:topology:example1}{Example of complex device topology}  
  \begin{SubGraph}{-3,3}{}
  \Vertex{1.5,0}{gw1}{gateway}
  \Vertex{-1.5,0}{m1}{mcu}  
  \Vertex{-1.5,-2}{t1}{terminal1}
  \Vertex{1.5,-2}{t2}{terminal2}
  \Vertex{-1.5,2}{a1}{userAgent1}
  \Vertex{1.5,2}{a2}{userAgent2}
  \EdgeAllToAll{<->}{hxxxIp, hxxxAlias}{m1, t1, t2}  
  \EdgeAllToAll{<->}{sipUri}{m1, a1, a2}  
  \Vertex{-4,-1}{ss1}{gatekeeper}  
  \Vertex{-4,1}{ss2}{proxy}  
  \end{SubGraph}
  
  \begin{SubGraph}{3,3}{}
  \Vertex{0,0}{s1}{server}  
  \Vertex{-1.5,-2}{c1}{client1}
  \Vertex{1.5,-2}{c2}{client2}
  \EdgeOneToAll{<-}{connectUrl}{s1}{c1, c2}
  \end{SubGraph}
  
  \Edge{<-}{connectUrl}{s1}{gw1}
  \EdgeOneToAll{<->}{hxxxIp, hxxxAlias}{gw1}{m1, t1, t2}            
  
  \begin{GraphLegend}{1, 5.5}
    \GraphLegendItem{hxxxIp}{Accessible by IP Address in H.323}
    \GraphLegendItem{hxxxAlias}{Accessible by H.323 Alias}
    \GraphLegendItem{sipUri}{Accessible by SIP URI}
    \GraphLegendItem{connectUrl}{Accessible by Adobe Connect URL}
  \end{GraphLegend}
\end{Graph}

\begin{TopologyExample}{proxy}{SIP signaling server}
technology: SIP, capability: [{type: SignalingServer}]
\end{TopologyExample}

\begin{TopologyExample}{gatekeeper}{H.323 signaling server}
technology: H323, capability: [{type: SignalingServer}]
\end{TopologyExample}

\begin{TopologyExample}{terminal1}{First H.323 terminal}
technology: H323, address: 147.251.99.1,
capability: [
  {type: StandaloneTerminal}, {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: H323, server: gatekeeper, alias: 9501}
]
\end{TopologyExample}

\begin{TopologyExample}{terminal2}{Second H.323 terminal}
technology: H323, address: 147.251.99.2,
capability: [
  {type: StandaloneTerminal}, {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: H323, server: gatekeeper, alias: 9502}
]
\end{TopologyExample}

\begin{TopologyExample}{userAgent1}{First SIP user agent}
technology: SIP,
capability: [
  {type: StandaloneTerminal}, {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: SIP, server: proxy, alias: sip:a1}
]
\end{TopologyExample}

\begin{TopologyExample}{userAgent2}{Second SIP user agent}
technology: SIP,
capability: [
  {type: StandaloneTerminal}, {type: [Send, Receive], channel: {count: 1}}, 
  {type: SignalingClient, technology: SIP, server: proxy, alias: sip:a2}
]
\end{TopologyExample}

\begin{TopologyExample}{mcu}{Multipoint device for H.323 and SIP}
technology: [H323, SIP], address: 147.251.99.3,
capability: [
  {type: [Send, Receive], channel: {count: *}}, 
  {type: VirtualRooming, room: [room1, room2]},
  {type: SignalingClient, technology: H323, server: proxy, 
     alias: {room1: 9503, room2: 9504}},
  {type: SignalingClient, technology: SIP, server: proxy, 
     alias: {room1: sip:r1, room2: sip:r2}}
]
\end{TopologyExample}

\begin{TopologyExample}{server}{Adobe Connect server}
technology: AdobeConnect,
capability: [
  {type: VirtualRooming, room: [room1, room2]}, 
  {type: [Send, Receive], channel: {count: *}}, 
]
\end{TopologyExample}

\begin{TopologyExample}{client1}{First Adobe Connect client}
technology: AdobeConnect, identity: srom@cesnet.cz,
capability: [
  {type: [Send, Receive], channel: {count: 1}}
]
\end{TopologyExample}

\begin{TopologyExample}{client2}{Second Adobe Connect client}
technology: AdobeConnect, identity: bouda@cesnet.cz,
capability: [
  {type: [Send, Receive], channel: {count: 1}}
]
\end{TopologyExample}

\begin{TopologyExample}{gateway}{Gateway between H.323 and Adobe Connect}
technology: [H323, AdobeConnect], address: 147.251.99.4,
capability: [
  {type: [Send, Receive], channel: {count: 1}},
  {type: Translate, rule: [{from: *, to: *}]},
  {type: SignalingClient, technology: H323, server: gatekeeper, alias: 9505}
]
\end{TopologyExample}

\section{Operations}

Device Topology implementation should allow dynamic modification when for 
instance some device parameters are changed to not force the whole topology 
reconstruction.      
      
\subsection*{Construction}

Construction is performed when the controller is started. Steps to construct a 
topology:

\begin{compactenum}
\item Get the list of all devices in the topology.
\item For each device: 
  \begin{compactitem}
  \item \textbf{Add new device}.
  \end{compactitem}
\end{compactenum}     

\subsection*{Add new device}     

Steps to add new device to the topology:
\begin{compactenum}
\item Get device capabilities.
\item Add a new node to the topology.
\item Find all other devices that the device is able to take a videoconference 
  with (based on capabilities):
  \begin{compactitem}
  \item Add edge(s) with proper parameters.
  \end{compactitem}
\end{compactenum}  

\subsection*{Update existing device}     

Steps to update an existing device in a topology for instance when the capabilities for the device are changed:
\begin{compactenum}
\item \textbf{Remove existing device}.
\item \textbf{Add new device}.
\end{compactenum} 
     
\subsection*{Remove existing device}     

Steps to remove existing device from a topology:
\begin{compactenum}
\item Remove all edges that reference the device.
\item Remove the node from the topology.
\end{compactenum}   
