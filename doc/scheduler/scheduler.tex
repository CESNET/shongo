\documentclass[a4paper]{report}
\usepackage{geometry}
\geometry{paper=a4paper}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenx}
\usepackage{palatino}
\usepackage{mathpazo}
\usepackage{microtype}
\renewcommand*\ttdefault{txtt}

\usepackage[czech,english]{babel}

\usepackage[pdftex,breaklinks=true,pdfborder={0 0 0}]{hyperref}
\usepackage[pdftex]{graphicx}
\usepackage{paralist} 
\usepackage{multicol}

\usepackage{tikz}
\usetikzlibrary{snakes,arrows,shapes,calc}
\usepackage{amsmath}
\usepackage[numbers]{natbib}

\usepackage{xcolor}
\newcommand{\TODO}[1]{%
\def\empty{}%
\def\prvniparametr{#1}%
\ifx\prvniparametr\empty%
\begingroup\tt\textcolor{red}{\noindent\textbf{TODO}}\endgroup
\else%
\begingroup\tt\textcolor{red}{\noindent\textbf{TODO:}\ #1}\endgroup
\fi%
}

\input{graph.tex}


\begin{document}


\title{Scheduler for Shongo}
\author{Petr Holub, Jan Růžička, Miloš Liška, Martin Šrom, Ondřej Pavelka, Ondřej Bouda}
\date{\copyright~CESNET~z.\,s.\,p.\,o.\\2012}
\maketitle
\tableofcontents


\chapter{Technology}

This chapter describes widely-used videoconference technologies. Element types and network examples are listed  for each technology.


\section{H.323}

The H.323 network is composed of terminals, multipoint control units, gateways and gatekeepers. Terminals, MCUs and gateways are referred to as endpoints. At least two terminals are needed to start a videoconference call.

\subsection{Elements}

\begin{itemize}

\item \textbf{Terminal} \\
Terminal represents a hardware device or a software client that enables a single person or a group of persons situated in front of the device to connect to another H.323 endpoint and take a videoconference call.

There are special terminal devices that provides a single virtual room to which can connect multiple other endpoints.  These terminals thus allow to make a multipoint videoconference even without the MCU.

\item \textbf{Multipoint Control Unit} (MCU) \\
MCU represents a hardware device that is used for hosting of videoconference calls in which can generally participate any number of endpoints. MCU contains one or more \textbf{virtual rooms} and each virtual room can host one videoconference call at the time. MCU can restrict the number of participants per virtual room or per whole MCU device.

\item \textbf{Gateway} \\
Gateway is device that enable communication between H.323 network and other networks (e.g., PSTN).

\item \textbf{Gatekeeper} \\
Gatekeeper is a hardware device that provides special services to the other elements in the network: endpoint registration, address resolution, admission control and user authentication.

\end{itemize}

Each H.323 element is running on specific IP address that can be used to connect to the element. An element can have assigned alias, \textbf{H.323 phone number} (defined by E.164) or \textbf{H.323 identifier} (string, e.g., email), that can be used to connect to it. Alias is useful when the IP address is not known (e.g., the device is behind the NAT) or it is likely to change (organization changes).

Alias can be assigned only to \textbf{terminal} or \textbf{virtual room} in MCU. When a terminal has assigned alias it must register to one \textbf{gatekeeper} that will be able to translate the alias to the terminal IP address. When an element want to connect to another terminal or virtual room by alias, it must use the same gatekeeper that has the proper registry of aliases.

When a gatekeeper is used in videoconference, it can work in two modes:
\begin{itemize}
\item Direct Endpoint Model -- The gatekeeper is used only for initialization (address resolution, admission control, etc.) and the videoconference call itself is managed by it's participants (endpoints). The gatekeeper doesn't have full control over the call signaling. The target IP address is communicated to the caller.
\item Gatekeeper Routed Model -- The gatekeeper is used throughout videoconference call, the call signaling flow through the gatekeeper and it has the full control over it. The target IP address is not communicated to the caller.
\end{itemize}

Each terminal and MCU element can have set zero or one gatekeeper. If gatekeeper is set then each terminal and virtual room in MCU can have an alias set. Each terminal and MCU element should also be configured to allow or forbid the direct connections through IP address. When the gatekeeper with admission control is set, it is appropriate to forbid direct connections through IP address.

\subsection{Constraints}

\begin{itemize}

\item Communication consists of:
\begin{compactenum}
\item Audio
\item Audio + Video
\item Audio + Data
\item Audio + Video + Data
\end{compactenum}
\TODO{Do we want to know in Topology which of 4 modes each device support?}

\item Always bidirectional connections. When an device $A$ can connect to a device $B$ then also $B$ can connect to $A$.

\end{itemize}

\subsection{Network Examples}

% H.323 Graph Declarations
\tikzstyle{hxxxData}=[color=red]
\tikzstyle{hxxxDataDashed}=[color=red, dashed]
\tikzstyle{hxxxControl}=[color=orange]
\tikzstyle{hxxxAlias}=[color=blue, dashed]
\tikzstyle{hxxxIp}=[color=green, dashed]
\newcommand{\HXXXLegend}[1]{
  \begin{GraphLegend}{#1}
    \GraphLegendItem{hxxxData}{Call data flow}
    \GraphLegendItem{hxxxControl}{Call control flow}
    \GraphLegendItem{hxxxAlias}{Connect by H.323 alias}
    \GraphLegendItem{hxxxIp}{Connect by IP address}
  \end{GraphLegend}
}

\subsubsection{Connection through direct IP addresses}

Terminals and virtual rooms in MCU don't have assigned any H.323 aliases thus the connecting is done through IP addresses. This topology allows for 2-point videoconferences (e.g., \emph{terminal1 -- terminal2}) and multipoint videoconferences through the MCU (e.g., \emph{terminal1 -- terminal2 -- terminal3 -- mcu}). When a terminal connects to the MCU it must select the proper virtual room, because the IP address determines only the MCU not a specific virtual room.

\begin{Graph}{graph:h323:direct}{Connection through direct IP addresses}
  \Vertex{0, 0}{t1}{terminal1}
  \Vertex{4, 0}{t2}{terminal2}
  \Vertex{4,-4}{t3}{terminal3}
  \Vertex{0,-4}{mcu}{mcu}
  
  \EdgeAllToAll{<->}{hxxxIp, hxxxData, hxxxControl}{t1, t2, t3, mcu}
  
  \HXXXLegend{6, -1.5}
\end{Graph}

\subsubsection{Connection through a gatekeeper (Direct Endpoint Model)}

Terminals and MCUs are configured to forbid direct connections through IP addresses. Terminals and MCU virtual rooms have assigned H.323 aliases and the devices register to the gatekeeper that is able to resolve these aliases to direct IP addresses. When a terminal want to start videoconference he must request the gatekeeper. The request must contain H.323 alias of another terminal or virtual room in MCU to which the terminal wants to connect. The gatekeeper resolves an IP address from the alias and return it to the caller which then is able to start videoconference data flow to the requested target.

\begin{Graph}{graph:h323:gatekeeper}{Connection through gatekeeper}
  \Vertex{ 0, 0}{t1}{terminal1}
  \Vertex{ 4, 0}{t2}{terminal2}
  \Vertex{ 4,-4}{t3}{terminal3}
  \Vertex{ 0,-4}{mcu}{mcu}
  \Vertex{-2,-2}{gk}{gatekeeper}
  
  \EdgeAllToAll{<->}{hxxxData, hxxxControl}{t1, t2, t3, mcu}
  \EdgeOneToAll{<->}{hxxxAlias}{gk}{t1, t2, t3, mcu}
  
  \HXXXLegend{6, -1.5}
\end{Graph}

\subsubsection{Connection through a gatekeeper (Gatekeeper Routed Model)}

Terminals and MCUs are configured to forbid direct connections through IP addresses. Terminals and MCU virtual rooms have assigned H.323 aliases and the devices register to the gatekeeper that is able to resolve these aliases to direct IP addresses. When a terminal want to start videoconference he must request the gatekeeper. The request must contain H.323 alias of another terminal or virtual room in MCU to which the terminal wants to connect. The gatekeeper resolves an IP address from the alias and establish connection to the target endpoint. The call is then mediated by the gatekeeper throughout the videoconference.

\begin{Graph}{graph:h323:gatekeeperRouted}{Connection through gatekeeper}
  \Vertex{0, 0}{t1}{terminal1}
  \Vertex{4, 0}{t2}{terminal2}
  \Vertex{4,-4}{t3}{terminal3}
  \Vertex{0,-4}{mcu}{mcu}
  \Vertex{-2,-2}{gk}{gatekeeper}
  
  \EdgeAllToAll{<->}{hxxxData}{t1, t2, t3, mcu}  
  \EdgeOneToAll{<->}{hxxxAlias, hxxxControl}{gk}{t1, t2, t3, mcu}
  
  \HXXXLegend{6, -1.5}
\end{Graph}

\subsubsection{Multiple gatekeepers}

The network is composed from 3 endpoints (\emph{terminal1, terminal2, mcu}) managed by \emph{gatekeeper1} and 2 subdomains where each is composed of 2 endpoints and one gatekeeper.%
\begin{Graph}{graph:h323:gatekeeperMultiple}{Multiple gatekeepers}
  \Vertex{ 0, 0}{gk1}{gatekeeper1}
  \Vertex{-2,-2}{gk2}{gatekeeper2}
  \Vertex{ 2,-2}{gk3}{gatekeeper3}
  \EdgeAllToAll{<->}{hxxxAlias, hxxxControl}{gk1, gk2, gk3}
  
  \Vertex{-2, 2}{t1}{terminal1}
  \Vertex{ 2, 2}{t2}{terminal2}
  \Vertex{ 0, 4}{mcu}{mcu}
  \EdgeAllToAll{<->}{hxxxIp, hxxxControl, hxxxData}{t1, t2, mcu}  
  \EdgeOneToAll{<->}{hxxxAlias, hxxxControl}{gk1}{t1, t2, mcu}  

  \Vertex{-5,-1}{t3}{terminal3}
  \Vertex{-5,-3}{t4}{terminal4}
  \Edge{<->}{hxxxIp, hxxxControl, hxxxData}{t3}{t4}
  \EdgeOneToAll{<->}{hxxxAlias, hxxxControl}{gk2}{t3, t4}  
     
  \Vertex{5,-1}{t5}{terminal5}
  \Vertex{5,-3}{t6}{terminal6}
  \Edge{<->}{hxxxIp, hxxxControl, hxxxData}{t5}{t6}
  \EdgeOneToAll{<->}{hxxxAlias, hxxxControl}{gk3}{t5, t6}    
  
  \Edge{<-}{hxxxDataDashed}{mcu}{$(mcu) + (0,1)$}
  \Edge{<-}{hxxxDataDashed}{t1}{$(t1) + (-1.5,0)$}
  \Edge{<-}{hxxxDataDashed}{t2}{$(t2) + (1.5,0)$}
  \Edge{<-}{hxxxDataDashed}{t3}{$(t3) + (0.3, 1)$}
  \Edge{<-}{hxxxDataDashed}{t4}{$(t4) + (0.8,-1)$}
  \Edge{<-}{hxxxDataDashed}{t5}{$(t5) + (-0.3, 1)$}
  \Edge{<-}{hxxxDataDashed}{t6}{$(t6) + (-0.8,-1)$}

  \HXXXLegend{4.5, 4}
\end{Graph}%
Adjacent endpoints (endpoints in the same local network) can connect directly or through it's gatekeeper. Not adjacent endpoints (endpoints from different local networks) can connect only by it's gatekeepers.

\subsection{Suggested Topology}
In topology should be present only endpoints (terminals, MCUs, gateways). The gatekeepers will be kept aside and will be used only to determine which devices are accessible by which devices and to limit the number of active connections that will flow through them (if maximum number of connections is specified for the gatekeeper).

\begin{Graph}{graph:h323:topology}{Suggested topology}  
  \Vertex{-2, 4}{gk1}{gatekeeper1}
  \Vertex{-2, 2}{t1}{terminal1}
  \Vertex{-2,-2}{t2}{terminal2}
  \Vertex{-4, 0}{mcu}{mcu}

  \Vertex{2, 4}{gk2}{gatekeeper2}  
  \Vertex{2, 2}{t3}{terminal3}
  \Vertex{2,-2}{t4}{terminal4}
  
  \node at (-2, 3) {\textit{subdomain1}};
  \node at ( 2, 3) {\textit{subdomain2}};
  \draw[dashed, color=gray](0,4.6) -- (0,-2.5);
  \draw[-](gk1) -- node[above, font=\scriptsize] {neightbours} (gk2);
  
  
  \EdgeAllToAll{<->}{hxxxAlias, hxxxIp}{t1, t2, mcu}  
  \EdgeAllToAll{<->}{hxxxAlias, hxxxIp}{t3, t4}  
  \EdgeOneToAll{<->}{hxxxAlias}{t3}{t1, t2, mcu}  
  \EdgeOneToAll{<->}{hxxxAlias}{t4}{t1, t2, mcu}  
  
  \begin{GraphLegend}{4, 0.5}
    \GraphLegendItem{hxxxAlias}{Accessible by alias}
    \GraphLegendItem{hxxxIp}{Accessible by IP}
  \end{GraphLegend}
\end{Graph}

\textbf{Notes:}
\begin{itemize}
\item Each gatekeeper should have set a list of neighboring gatekeepers and a list of redirection rules for H.323 phone numbers.
\item At the global level there should be a list of rules that defines which devices are accessible to which device by IP address (similarly to firewall definition).
\end{itemize}
\TODO{How many nodes will we support? 1000 nodes may cause 1000$^2$ edges, and it is a lot....}

\subsection{References}

\renewcommand{\bibsection}{}
\begin{thebibliography}{1}
\bibitem[1]{bib:h323:wiki}
H.323 on Wikipedia.
\\\url{https://en.wikipedia.org/wiki/H.323}

\bibitem[2]{bib:h323:architecture}
Basic Architecture of H.323.
\\\url{http://hive1.hive.packetizer.com/users/packetizer/papers/h323/h323_basics_handout.pdf}

\bibitem[3]{bib:h323:gatekeepers}
Understanding H.323 Gatekeepers.
\\\url{http://www.cisco.com/en/US/tech/tk1077/technologies_tech_note09186a00800c5e0d.shtml}
\end{thebibliography}


\section{SIP}

The Session Initiation Protocol (SIP) is a signaling protocol for establishing calls and videoconferences over IP networks.

\subsection{Elements}

Type of elements in SIP network:

\begin{itemize}
\item \textbf{User Agent} \\
User agent is a hardware or software client that allows user to take a 
videoconference call. It can create and receive SIP messages and thereby
manage a SIP session.
\\ \TODO{Can user agent have set one or more servers which it will use for initiating a call?}
\item \textbf{Proxy Server} \\
Proxy server is an intermediary entity whose main role is to route requests to another entity that is closer to the target. Proxy server can also perform admission control.
\item \textbf{Redirect Server} \\
Redirect server response to each client request by alternative set of URIs which should client contact instead of the original target.
\item \textbf{Registrar} \\
Registrar is an element that keeps register of user agents. Each user agent can register itself to a registrar for a specific URI. More user agents can be registered to a single URI. 
\\ \TODO{Can one agent be registered multiple times to a single/multiple registers?}
\item \textbf{Gateway} \\
Gateway is a device that enable communication between SIP network and other networks (e.g., PSTN).
\item \TODO{Is there a similar entity like a MCU in H.323 to create a virtual room?}
\end{itemize}

Each element in a SIP network is identified by an uniform resource identifier (URI), for instance \verb|sip:username:password@host:port|. Single element in SIP network can be a combination of multiple SIP element types (e.g., \emph{Proxy and Registrar Server} or \emph{Redirect and Registrar Server}).

\subsection{Constraints}

\begin{itemize}

\item Communication consists of:
\begin{compactenum}
\item Audio
\item Audio + Video
\item Audio + Video + Data
\end{compactenum}

\end{itemize}

\subsection{Network Examples}

% SIP Graph Declarations
\tikzstyle{sipUri}=[color=blue, dashed]
\newcommand{\SipLegend}[1]{
  \begin{GraphLegend}{#1}
    \GraphLegendItem{sipUri}{Accessible by URI}
  \end{GraphLegend}
}

\TODO{List some}

\subsection{Suggested topology}

In topology are present only user agents and gateways. Server elements are used only when the topology is constructed to determine which elements are accessible from which elements.

\begin{Graph}{graph:sip:topology}{Suggested topology}  
  \Vertex{-2, 2}{a1}{useAgent1}
  \Vertex{-2,-2}{a2}{useAgent2}
  \Vertex{2, 2}{a3}{useAgent3}  
  \Vertex{2, -2}{a4}{useAgent4}
  
  
  \EdgeAllToAll{<->}{sipUri}{a1, a2, a3, a4}  
  
  \begin{GraphLegend}{4, 0}
    \GraphLegendItem{sipUri}{Accessible by URI}
  \end{GraphLegend}
\end{Graph}

\subsection{References}

\renewcommand{\bibsection}{}
\begin{thebibliography}{1}

\bibitem[1]{bib:sip:architecture}
Session Initiation Protocol (SIP)
\\ \url{http://www.vide.net/cookbook/cookbook.en/list_page.php?topic=3&url=sip.htm}

\bibitem[2]{bib:sip:wiki}
Session Initiation Protocol on Wikipedia.
\\ \url{https://en.wikipedia.org/wiki/Session_Initiation_Protocol}

\end{thebibliography}


\section{Adobe Connect}

\TODO{Describe Adobe Connect}

\subsection{Elements}

Type of elements in Adobe Connect network:

\begin{itemize}
\item \textbf{Client} \\
\TODO{}
\item \textbf{Server} \\
\TODO{}
\end{itemize}


\chapter{Topology}

Topology is representation of videoconferencing devices from various technologies and it's relations. Each domain controller in Shongo will keep in memory the local topology of all devices that the controller manages.
Controller will know nothing about topologies from foreign domains. Every time when the controller needs some information about foreign devices it send request to foreign domain controller.

Topology is composed of nodes and edges. Nodes represents a videoconference devices and and edges theirs relations, ability to communicate.

\section{Node}

Each node in Topology represents one videoconference device. Device is able to communicate with one or more technologies (H.323, SIP, Adobe Connect, etc.).
\\
If device is able to communicate with a \textbf{technology} it means that it 
has at least one capability from the following types (for that technology):
\begin{compactitem}
\item \textbf{receive} and/or \textbf{send} through a limited number of 
  the technology input/output \textbf{channels}. Each channel must contain 
  at least one of the following \textbf{streams}:
  \begin{itemize}
    \item \textbf{audio} in a specific \textbf{audio codecs} and 
      \textbf{bitrates}.
    \item \textbf{video} in a specific \textbf{video codecs} and 
      \textbf{resolutions}.
    \item \textbf{content} in a specific \textbf{content formats}.
  \end{itemize} 
\item \textbf{mix} input channels and send the combined result through 
  an output channel.
\item \textbf{virtual rooming} means that the device divides input channels 
  into groups (virtual rooms), \textbf{mixing} is applied per group and
  each group is bound to one output channel. For each virtual room there can 
  be specified the maximum number of input channels (maximum videoconference 
  participants).
\item \textbf{gatekeeper client} means that the device has set an alias 
  and an address of a gatekeeper server to which it registers itself.
  When the device want to connect to another device by an alias it contacts 
  the gatekeeper server which resolves the device address from the alias 
  or route the videoconference through the gatekeeper server (and do not tell
  the resolved address to the caller).
\item \textbf{gatekeeper server} means that the device is gatekeeper server
  that has registry of devices and its' aliases. The gatekeeper server is
  able to resolve addresses or route the videoconference through itself. It is 
  able to perform an admission control or user authentication.
\item \textbf{stream} from an input channel.
\item \textbf{record} from an input channel.
\item \TODO{Describe used capacity by scheduler...}
\end{compactitem}
Each device can have one or more described capabilities for each technology
that it supports.
If device is able to communicate with a multiple technologies it can also have the following capabilities:
\begin{compactitem}
\item \textbf{translate} the technology input channel to another technology output 
  channel.
\end{compactitem}


\subsection*{Examples of abstract devices (not bound to any technology):}
\begin{itemize}
\item \textbf{Terminal device} \\
  Terminal device is hardware or software client that is used by an user to 
  connect to a videoconference. The device allow user to participate only in
  one videoconference at the time thus it has \textbf{receive} and 
  \textbf{send} capability but limited to 1 channel. No other capability is 
  provided by the simple terminal device. If we have available only terminal 
  devices we are able to establish only 2-point videoconferences 
  (terminal-to-terminal links).

\item \textbf{Terminal device with embedded virtual room} \\
  Terminal device with embedded virtual room is extension of terminal device 
  that allows user to host a single multipoint videoconference. The device has 
  \textbf{receive} capability with limited number of input channels to number 
  of allowed participants in the provided single virtual room. It also has 
  \textbf{send} capability but limited to 1 channel. The last provided 
  capability is \textbf{mix} which combines input channels to a single output 
  channel and through it mediates the multipoint videoconference. It is worth 
  to note that the terminal device with embedded virtual room itself is part of 
  the hosted videoconference.

\item \textbf{Multipoint device} \\
  Multipoint device is a special type of device that hosts one or more virtual 
  rooms and an arbitrary device can connect to a hosted virtual room and take 
  a videoconference there. The difference between multipoint and the previous 
  device is that the multipoint device can host more than one videoconference 
  and the multipoint device isn't part of these videoconferences, it only 
  manages them. The multipoint device has \textbf{receive}, \textbf{send} and 
  \textbf{virtual rooming} capabilities. Number of input channels for 
  \textbf{receive} capability is limited to a maximum number of participants 
  in all hosted videoconferences in the device. Number of output channels for 
  \textbf{send} capability is limited to a maximum number of virtual rooms 
  (=~videoconferences) in the device. \textbf{Virtual rooming} capability 
  provides the ability to mix input channels to one output channel 
  that is routed to all participants in each virtual room.

\item \textbf{Gatekeeper device} \\
  Gatekeeper device is a special type of device that has only 
  \textbf{gatekeeper server} capability. All of previous device examples can 
  also have \textbf{gatekeeper client} capability which allows them to use a 
  device alias as a videoconference callee specification. When device alias is 
  used for initiating the videoconference then the device contacts the proper 
  gatekeeper which has two options: to resolve address from the alias and 
  return it to the caller or to route the videoconference through the 
  gatekeeper.
\end{itemize}
 

\section{Edge}

Edge links two nodes (devices) and it represents a relation between the 
nodes. The relation can have a various meaning, for instance that the devices
are able to take a videoconference together in a specific technology or
that the first device is a gatekeeper and the second can resolve a device 
address from an alias (in specific technology as well).
\\
The edge can represents a relation in one or more technologies. For each \textbf{technology} that the edge relates to, the edge can have one or more 
capabilities from the following types:
\begin{compactitem}   
\item \textbf{channel} means that between two devices can be established
  a communication channel. It must contain at least one of the following 
  \textbf{streams}:
  \begin{itemize}
    \item \textbf{audio} in a specific \textbf{audio codecs} and 
      \textbf{bitrates}.
    \item \textbf{video} in a specific \textbf{video codecs} and 
      \textbf{resolutions}.
    \item \textbf{content} in a specific \textbf{content formats}.
  \end{itemize} 
  
\item \TODO{Describe weights...}
   \\ \TODO{Describe used capacity by scheduler...}
\end{compactitem}   
  

\chapter{Technology Implementation in Topology}
Each videoconference network in a specific technology can be implemented by Topology. This chapter shows examples of network implementation for each technology.

\TODO{Show examples}

\section{H.323}

\section{SIP}

\section{Adobe Connect}


\chapter{Topology Implementation}

\TODO{Describe implementation better}

Topology implementation should allow dynamic modification when for instance some device parameters are changed to not force the whole topology reconstruction.      
      
\section{Construction}

Construction is performed when the controller is started. Steps to construct a topology:

\begin{enumerate}

\item Get the list of all devices with it's capabilities in a topology.

\item For each device: 
  \begin{compactitem}
  \item Find all other devices that the device is able to transmit
  data to (or to make a call) and for each:
    \begin{compactitem}
    \item Add edge with proper parameters.
    \end{compactitem}
  \end{compactitem}

\end{enumerate}     
     
\section{Update Topology}     

Steps to update a topology when the capabilities for a device are changed:
\begin{enumerate}

\item Remove all edges that reference the device.

\item Find all other devices that the device is able to transmit data from/to
   (or to make a call) and for each:
   \begin{compactitem}
   \item Add edge(s) with proper parameters.
   \end{compactitem}

\end{enumerate}  


\chapter{Scheduler}

Scheduler will use described Topology implementation for scheduling reservations of videoconference devices.

\TODO{Describe scheduler}


\end{document}