\chapter{Implementation}
\input{commands}

\lstset{
  classoffset=1,
  morekeywords={
    % Common
    DateTime, AbsoluteDateTime, PeriodicDateTime, Period, Duration,
    DateTimeSlot, AbsoluteDateTimeSlot, Person
    % Capabilities
    TerminalCapability, StandaloneTerminalCapability, VirtualRoomsCapability, 
    AliasProviderCapability,
    % Resources
    Resource, DeviceResource, ManagedMode,
    % Enums
    H323, SIP, AdobeConnect, E164, URI
  }
}

This chapter describes how is implemented database of \glspl{g:resource} and how are \glspl{g:reservation-request} allocated to \glspl{g:reservation} in \gls{g:controller} from the API point of view.

\section{Resource database}

Each \gls{g:controller} contains persistent database of \glspl{g:resource}. New \glspl{g:resource} can be added to the \gls{g:controller}'s database and existing \glspl{g:resource} can be modified or deleted through the \gls{g:controller}'s API. A running \gls{g:controller} holds it's database of \glspl{g:resource} in memory and when it is restarted it reloads the database from a persistent storage. Class diagram for \glspl{g:resource} that are persisted in the database is shown in fig. \ref{fig:cd_resources}.

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/cd_resources_api}
\label{fig:cd_resources}
\caption{Class diagram for \gls{g:resource} database in the \gls{g:controller} API}
\end{figure}

A \gls{g:resource} can be created by an instance of \ApiRef{Resource} or \ApiRef{DeviceResource} class. Each \gls{g:resource} is identified by an unique \code{identifier} which is generated by the \gls{g:controller} when the \gls{g:resource} is created in the database. Each resource must have specified if it is \code{allocatable}. If a resource isn't \code{allocatable} a scheduler cannot allocate it to a \gls{g:reservation}. A resource can also have specified \code{maximumFuture} which restrict the \gls{g:controller}'s scheduler to allocate the \gls{g:resource} only to maximum date/time computed as current date/time plus specified \code{maximumFuture}. When a \gls{g:resource} is requested for a \gls{g:reservation} which exceeds the maximum date/time, the scheduler will report an error.

Each resource can have specified zero, one or more \code{capabilities}. Capabality specifies that a \gls{g:resource} provide some kind of feature or service. Some capabilities can be used only for a \ApiRef{DeviceResource} (e.g., \ApiRef{TerminalCapability} or \ApiRef{VirtualRoomsCapability}). Complete description of capabilities can be found in chapter \ref{chapter:controller-api}, but here is short summary:
\begin{compactitem}
\item \ApiRef{TerminalCapability} tells that a \gls{g:resource-device} can participate in a \gls{g:compartment} (must be connected into a \gls{g:device-virtual-room}).
\item \ApiRef{StandaloneTerminalCapability} tells that a \gls{g:resource-device} can participate in a \gls{g:compartment} which can consist only of two \glspl{g:endpoint} without a \gls{g:device-virtual-room}.
\item \ApiRef{VirtualRoomsCapability} tells that a \gls{g:resource-device} can host multiple \glspl{g:device-virtual-room}.
\item \ApiRef{AliasProviderCapability} tells that a \gls{g:resource} can allocate an \gls{g:device-alias} which then can be assigned to a managed \gls{g:endpoint} or \gls{g:device-virtual-room}.
\end{compactitem}

Here are some examples of resources which can be added to a \gls{g:resource} database in a \gls{g:controller} of \ApiValue{cz.cesnet} \gls{g:domain}:

\begin{itemize}

\item Codian MCU which can host multiple H.323 \glspl{g:device-virtual-room} (the limit is 20 ports for all rooms) and which can assign \glspl{g:device-alias} in range \ApiValue{9500872XX} to hosted \glspl{g:device-virtual-room}.

\begin{ObjectCode}{DeviceResource}{mcu}{}
identifier: shongo:cz.cesnet:1,
name: mcu,
description: Codian MCU 4515,
allocatable: true,
maximumFuture: Period(P4M),
technologies: [H323],
capabilities: [
  VirtualRoomsCapability {
    portCount: 20
  },
  AliasProviderCapability {
    technology: H323,
    type: E164,
    pattern: 9500872[dd],
    restrictedToOwnerResource: true 
  }
],
mode: ManagedMode{
  connectorAgentName: codian
}
\end{ObjectCode}

\item Endpoint Tandberg Codec C90 can participate in H.323 \glspl{g:compartment} and has assigned a H.323 \gls{g:device-alias} \ApiValue{950081038}. 

\begin{ObjectCode}{DeviceResource}{endpoint}{}
identifier: shongo:cz.cesnet:2,
name: endpoint,
description: Tandberg Codec C90,
allocatable: true,
maximumFuture: Period(P4M),
technologies: [H323],
capabilities: [
  StandaloneTerminalCapability {
    aliases: [
      Alias {
        technology: H323,
        type: E164,
        value: 950081038,
      }
    ]
  }
],
mode: ManagedMode{
  connectorAgentName: c90
}
\end{ObjectCode}

\item \Gls{g:resource} representing a physical lecture room.

\begin{ObjectCode}{Resource}{room}{}
identifier: shongo:cz.cesnet:3,
name: room,
description: Lecture room,
allocatable: true,
\end{ObjectCode}


\item Another Tandberg endpoint which is located inside the \code{room} (\ApiValue{shongo:cz.cesnet:3}) and when the endpoint is allocated the room must be also allocated and thus when the room cannot be allocated, the endpoint fails to allocate.

\begin{ObjectCode}{DeviceResource}{anotherEndpoint}{}
identifier: shongo:cz.cesnet:4,
parentIdentifier: ⠶\textcolor{red}{shongo:cz.cesnet:3}⠶,
...
technologies: [H323],
capabilities: [
  StandaloneTerminalCapability {
    ...
  }
],
...
\end{ObjectCode}

\item \Gls{g:resource} that can allocate an \gls{g:device-alias} (H.323 phone number or SIP URI) which then can be assigned to any managed \gls{g:endpoint} or \gls{g:device-virtual-room} in allocated \gls{g:compartment}.

\begin{ObjectCode}{Resource}{aliasProvider}{}
identifier: shongo:cz.cesnet:5,
name: aliasProvider,
description: Provider for H323 and SIP aliases,
allocatable: true,
maximumFuture: Period(P2Y)
capabilities: [  
  AliasProviderCapability {
    technology: H323,
    type: E164,
    pattern: 9500873[dd],
  }
  AliasProviderCapability {
    technology: SIP,
    type: URI,
    pattern: [ddd]@shongo.cesnet.cz,
  }
]
\end{ObjectCode}

\end{itemize}


\section{Reservation requests and reservations}
