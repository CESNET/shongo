\chapter{Implementation}
\input{commands}

\lstset{
  classoffset=1,
  morekeywords={
    % Common
    DateTime, AbsoluteDateTime, PeriodicDateTime, Period, Duration,
    DateTimeSlot, AbsoluteDateTimeSlot, Person
    % Capabilities
    TerminalCapability, StandaloneTerminalCapability, VirtualRoomsCapability, 
    AliasProviderCapability,
    % Resources
    Resource, DeviceResource, ManagedMode,
    % Enums
    H323, SIP, AdobeConnect, E164, URI
  }
}

This chapter describes the implementation for database of \glspl{g:resource} and allocation of \glspl{g:reservation-request} to \glspl{g:reservation} in \gls{g:controller} from the API point of view.

\section{Resource database}

Each \gls{g:controller} contains persistent database of \glspl{g:resource}. New \glspl{g:resource} can be added to the \gls{g:controller}'s database and existing \glspl{g:resource} can be modified or deleted through the \gls{g:controller}'s API. A running \gls{g:controller} holds it's database of \glspl{g:resource} in memory and when it is restarted it reloads the database from a persistent storage. Class diagram for \glspl{g:resource} that are persisted in the database is shown in fig. \ref{fig:cd_api_resources}.

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/cd_api_resources}
\caption{Class diagram for \gls{g:resource} database in the \gls{g:controller} API}
\label{fig:cd_api_resources}
\end{figure}

A \gls{g:resource} can be created by an instance of \ApiRef{Resource} or \ApiRef{DeviceResource} class. Each \gls{g:resource} is identified by an unique \code{identifier} which is generated by the \gls{g:controller} when the \gls{g:resource} is created in the database. Each resource must have specified if it is \code{allocatable}. If a resource isn't \code{allocatable} a scheduler cannot allocate it to a \gls{g:reservation}. A resource can also have specified \code{maximumFuture} which restrict the \gls{g:controller}'s scheduler to allocate the \gls{g:resource} only to maximum date/time computed as current date/time plus specified \code{maximumFuture}. When a \gls{g:resource} is requested for a \gls{g:reservation} which exceeds the maximum date/time, the scheduler will report an error.

Each resource can have specified zero, one or more \code{capabilities}. Capabality specifies that a \gls{g:resource} provide some feature or service. Some capabilities can be used only for a \ApiRef{DeviceResource} (e.g., \ApiRef{TerminalCapability} or \ApiRef{VirtualRoomsCapability}). Complete description of capabilities can be found in chapter \ref{chapter:controller-api}, but here is a short summary:
\begin{compactitem}
\item \ApiRef{TerminalCapability} tells that a \gls{g:resource-device} can participate in a \gls{g:compartment} (must be connected into a \gls{g:device-virtual-room}).
\item \ApiRef{StandaloneTerminalCapability} tells that a \gls{g:resource-device} can participate in a \gls{g:compartment}. The compartment may consist only of two \glspl{g:endpoint} without a \gls{g:device-virtual-room}.
\item \ApiRef{VirtualRoomsCapability} tells that a \gls{g:resource-device} can host multiple \glspl{g:device-virtual-room}.
\item \ApiRef{AliasProviderCapability} tells that a \gls{g:resource} can allocate an \gls{g:device-alias} which then can be assigned to a managed \gls{g:endpoint} or \gls{g:device-virtual-room}.
\end{compactitem}

Here are some examples of resources which can be added to a \gls{g:resource} database in a \gls{g:controller}, e.g., for \ApiValue{cz.cesnet} \gls{g:domain}:

\begin{itemize}

\item Codian MCU which can host multiple H.323 \glspl{g:device-virtual-room} (the limit is 20 ports for all rooms) and which can assign \glspl{g:device-alias} in range \ApiValue{9500872XX} to hosted \glspl{g:device-virtual-room}.

\begin{ObjectCode}{DeviceResource}{mcu}{}
identifier: shongo:cz.cesnet:1,
name: mcu,
description: Codian MCU 4515,
allocatable: true,
maximumFuture: Period(P4M),
technologies: [H323],
capabilities: [
  VirtualRoomsCapability {
    portCount: 20
  },
  AliasProviderCapability {
    technology: H323,
    type: E164,
    pattern: 9500872[dd],
    restrictedToOwnerResource: true 
  }
],
mode: ManagedMode{
  connectorAgentName: codian
}
\end{ObjectCode}

\item Endpoint Tandberg Codec C90 can participate in H.323 \glspl{g:compartment} and it has assigned a H.323 \gls{g:device-alias} \ApiValue{950081038}. 

\begin{ObjectCode}{DeviceResource}{endpoint}{}
identifier: shongo:cz.cesnet:2,
name: endpoint,
description: Tandberg Codec C90,
allocatable: true,
maximumFuture: Period(P4M),
technologies: [H323],
capabilities: [
  StandaloneTerminalCapability {
    aliases: [
      Alias {
        technology: H323,
        type: E164,
        value: 950081038,
      }
    ]
  }
],
mode: ManagedMode{
  connectorAgentName: c90
}
\end{ObjectCode}

\item \Gls{g:resource} representing a physical lecture room.

\begin{ObjectCode}{Resource}{room}{}
identifier: shongo:cz.cesnet:3,
name: room,
description: Lecture room,
allocatable: true,
\end{ObjectCode}


\item Another Tandberg endpoint which is located inside the \code{room} (\ApiValue{shongo:cz.cesnet:3}) and when the endpoint is allocated the room must be also allocated and thus when the room cannot be allocated, the endpoint fails to allocate.

\begin{ObjectCode}{DeviceResource}{anotherEndpoint}{}
identifier: shongo:cz.cesnet:4,
parentIdentifier: ⠶\textcolor{red}{shongo:cz.cesnet:3}⠶,
...
technologies: [H323],
capabilities: [
  StandaloneTerminalCapability {
    ...
  }
],
...
\end{ObjectCode}

\item \Gls{g:resource} that can allocate an \gls{g:device-alias} (H.323 phone number or SIP URI) which then can be assigned to any managed \gls{g:endpoint} or \gls{g:device-virtual-room} in an allocated \gls{g:compartment}.

\begin{ObjectCode}{Resource}{aliasProvider}{}
identifier: shongo:cz.cesnet:5,
name: aliasProvider,
description: Provider for H323 and SIP aliases,
allocatable: true,
maximumFuture: Period(P2Y)
capabilities: [  
  AliasProviderCapability {
    technology: H323,
    type: E164,
    pattern: 9500873[dd],
  }
  AliasProviderCapability {
    technology: SIP,
    type: URI,
    pattern: [ddd]@shongo.cesnet.cz,
  }
]
\end{ObjectCode}

\end{itemize}


\section{Reservation requests}

Each controller runs a component which process incoming \glspl{g:reservation-request} which can be created by \glspl{g:user} through a \gls{g:controller-client} and the requests are persisted in the \gls{g:controller}'s storage. New \glspl{g:reservation-request} can be created and existing \glspl{g:reservation-request} can be modified or deleted. Class diagram for \glspl{g:reservation-request} is shown in fig. \ref{fig:cd_api_reservation_requests}.

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/cd_api_reservation_requests}
\caption{Class diagram for \glspl{g:reservation-request} in the \gls{g:controller} API}
\label{fig:cd_api_reservation_requests}
\end{figure}

There are two types of \glspl{g:reservation-request}:
\begin{enumerate}
\item \ApiRef{ReservationRequestSet} represents a compound request which can result into multiple \ApiRef{ReservationRequest}s. It must specify one or multiple date/time \code{slots} and one or multiple \code{specifications} for targets which the user wants to get allocated. A single date/time slot can be specified as periodic (e.g., each Tuesday from 14:00 to 16:00 from September to June). 

Multiple date/time slots allows us to specify multiple specific date/times (e.g., today and tomorrow from 13:00 to 15:00) or even multiple periodic date/times (e.g., each Tuesday from 14:00 to 16:00 and Thursday from 16:00 to 18:00 from September to June).

Multiple specifications allows us to request multiple \glspl{g:compartment} or \glspl{g:resource} (e.g., we specify one compartment of H.323 and SIP participants for audio and video and another compartment in web conferencing technology to share content and these two compartments won't be interconnected but will be present at the same date/time slot or slots).

Periodic date/time slots must be enumerated to absolute date/time slots and for each absolute date/time slot and each specification is created one \ApiRef{ReservationRequest} (a Cartesian product of enumerated \code{slots} and \code{specifications}).

\todo{ReservationRequests created for the same date/time slot should be dependent to each other (allocation succeeds for all or none). [not implemented yet]}

\item \ApiRef{ReservationRequest} represents a minimum processable unit for a \gls{g:scheduler} which can be allocated to a \gls{g:reservation}. It must specify exactly one absolute date/time \code{slot} (periodic date/time cannot be used here) and one \code{specification} for a target which should be allocated.
\end{enumerate}

There are several types of specifications for targets which can be requested for allocation in \glspl{g:reservation-request}:
\begin{enumerate}
\item \ApiRef{AliasSpecification} allows us to get allocated an available \gls{g:device-alias}. When we receive an \gls{g:device-alias} \gls{g:reservation} we can use it for our purposes (e.g., assign the \gls{g:device-alias} to our hardware endpoint or installed software client) or we can use it when creating another \gls{g:reservation-request} and pass the \gls{g:device-alias} \gls{g:reservation} to the request. A \gls{g:scheduler} then can use the \gls{g:device-alias} as available resource when it is allocating a \gls{g:reservation} for the \gls{g:reservation-request} (e.g., assign it to any managed \gls{g:endpoint} or created \gls{g:device-virtual-room}). 

\item \ApiRef{ExistingEndpointSpecification} allows us to get allocated a specific \gls{g:endpoint} \gls{g:resource-device}. Then we can use it in the requested date/time slot for our purposes (e.g., we request an H.323 \gls{g:endpoint} in a lecture room and we get allocated reservation for the \gls{g:endpoint} and also for the lecture room, we can go to the lecture room and use the \gls{g:endpoint} to connect a conference).

\item \ApiRef{LookupEndpointSpecification} allows us to get allocated an \gls{g:endpoint} according to given parameters (e.g., \gls{g:technology} of the \gls{g:endpoint}). The \gls{g:scheduler} will search for an available \gls{g:endpoint} in the \gls{g:resource} database.

\item \ApiRef{CompartmentSpecification} allows us to get allocated a whole \gls{g:compartment}. We specify one or multiple \code{participants} and the scheduler allocates for us all specified \glspl{g:endpoint} and finds available \glspl{g:device-virtual-room} and \glspl{g:device-alias} which are needed to establish the \gls{g:compartment} and allocates them too. As part of the \ApiRef{CompartmentSpecification} we can also specify \code{callInitiation} -- who should initiate the \gls{g:device-connection} whether a \gls{g:device-virtual-room} or an \gls{g:endpoint} (see \ApiRef{CallInitiation} for more details).

\item \ApiRef{ExternalEndpointSpecification} can be specified only inside a \ApiRef{CompartmentSpecification} and it allows us to request a \gls{g:compartment} where should be available ports for external \glspl{g:endpoint} (e.g., user creates a \gls{g:reservation-request} for a \gls{g:compartment} and he specifies that he want 3 external \glspl{g:endpoint} in H.323 and thus the scheduler allocates a \gls{g:reservation} for a single H.323 \gls{g:device-virtual-room} for 3 ports; if the user has also specified one existing \gls{g:endpoint} the scheduler would allocate a H.323 \gls{g:device-virtual-room} for 4 ports).

\item \ApiRef{PersonSpecification} can be also specified only inside a \ApiRef{CompartmentSpecification} and it allows us to request a specific person to participate in a \gls{g:compartment}.

\todo{User must be invited to a videoconference (e.g., by email) and he must select an endpoint by which he will connect to the compartment. [not fully implemented yet]}
\end{enumerate}

A \gls{g:reservation-request} (\ApiRef{ReservationRequest}) can be in one of a several states (see fig. \ref{fig:smd_api_reservation_request}):
\begin{enumerate}
\item \code{NOT\_COMPLETE} A \gls{g:reservation-request} is not ready for allocation by a \gls{g:scheduler} (e.g., some person requested by the \ApiRef{PersonSpecification} hasn't confirmed/rejected the invitation or he hasn't selected an endpoint by which he will connect to a \gls{g:compartment}).
\item \code{COMPLETE} A \gls{g:reservation-request} is ready for allocation by a \gls{g:scheduler}, but the \gls{g:scheduler} hasn't allocate it yet.
\item \code{ALLOCATED} A \gls{g:reservation-request} has been successfully allocated by the \gls{g:scheduler} to a \gls{g:reservation}.
\item \code{ALLOCATION\_FAILED} A \gls{g:reservation-request} has been successfully allocated by the \gls{g:scheduler} to a \gls{g:reservation}.
\end{enumerate}

\begin{figure}[ht!]
\centering\includegraphics[width=10cm]{diagrams/smd_api_reservation_request}
\caption{State diagram for \gls{g:reservation-request} in the \gls{g:controller} API}
\label{fig:smd_api_reservation_request}
\end{figure}

Only complete \glspl{g:reservation-request} are allocated by the \gls{g:scheduler} to \glspl{g:reservation}.


\section{Reservations}

\Gls{g:reservation} is an object through an user receive allocated \glspl{g:resource} which he is requesting. Each reservation is identified by an unique \ApiCode{identifier} and it is allocated for one specific date/time \ApiCode{slot}. Reservation can contain some child \glspl{g:reservation} which has been allocated to satisfy parent allocation needs (e.g., a \gls{g:reservation} for a \gls{g:compartment} may contain child \glspl{g:reservation} for \glspl{g:endpoint}, \glspl{g:device-virtual-room} or \glspl{g:device-alias}, and a \gls{g:reservation} for an \gls{g:endpoint} may contain child \gls{g:reservation} for a lecture room).

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/cd_api_reservations}
\caption{Class diagram for \glspl{g:reservation} in the \gls{g:controller} API}
\label{fig:cd_api_reservations}
\end{figure}

There are several types of \glspl{g:reservation}:
\begin{enumerate}
\item \ApiRef{ResourceReservation} represents a \gls{g:reservation} for a \gls{g:resource} from the \gls{g:resource} database (e.g., \gls{g:reservation} for a H.323 \gls{g:endpoint} for a specific date/time slot or a \gls{g:reservation} for a lecture room for a specific date/time slot). For each resource and date/time slot can exist only one reservation (reservation must not collide).
\item \ApiRef{VirtualRoomReservation} represents a special type of \ApiRef{ResourceReservation} for a \gls{g:device-virtual-room} in the \gls{g:resource-device} with a \ApiRef{VirtualRoomsCapability} (e.g., a \gls{g:reservation} for a \gls{g:device-virtual-room} with 5 available ports in H.323 MCU \gls{g:resource}). These \glspl{g:reservation} can collide (multiple \glspl{g:device-virtual-room} can be created at the same time), but must not exceed the maximum number of ports specified in the \ApiRef{VirtualRoomsCapability}.
\item \ApiRef{AliasReservation} represents a special type of \ApiRef{ResourceReservation} for an \ApiCode{alias} from the \gls{g:resource} with an \ApiRef{AliasProviderCapability} (e.g., a \gls{g:reservation} for an \gls{g:device-alias} \ApiValue{950087201} from a \gls{g:resource} which provides \glspl{g:device-alias} with prefix \ApiValue{9500872XX}).
\item \ApiRef{CompartmentReservation} represents a \gls{g:reservation} for a \gls{g:compartment} and it usually contains multiple child \glspl{g:reservation} for \glspl{g:device-virtual-room}, \glspl{g:endpoint} and \glspl{g:device-alias}. It also contains a reference to \ApiCode{compartment} (instance of \ApiRef{Compartment} class) which represents a \gls{g:compartment} plan which is used by an \gls{g:executor} to establish the \gls{g:compartment}.
\end{enumerate}

The following two diagrams describes how \ApiRef{ReservationRequest}s and \ApiRef{ReservationRequestSet}s are processed by a \gls{g:controller} and allocated to \ApiRef{Reservation}s (fig. \ref{fig:sd_reservation_request_allocation} and \ref{fig:sd_reservation_request_set_allocation}). Each controller runs these components:
\begin{enumerate}
\item \textbf{Reservation service} accepts new \glspl{g:reservation-request} from users (through \glspl{g:controller-client}) and also new \glspl{g:reservation} from the \gls{g:scheduler} and persist them to \gls{g:controller}'s storage.
\item \textbf{Preprocessor} uses the service to get not-preprocessed \ApiRef{ReservationRequestSet}s and creates new \ApiRef{ReservationRequest}s from them. Preprocessor creates only requests which take place in working interval (e.g., one month ahead). It allows an user to create a \ApiRef{ReservationRequestSet} specifying never-ending periodic date/time (e.g., each Thursday from 14:00 to 16:00) and as the weeks goes the preprocessor will create more and more \ApiRef{ReservationRequest}s.
\item \textbf{\Gls{g:scheduler}} uses the service to get complete \ApiRef{ReservationRequest}s and allocates them to \ApiRef{Reservation}s.
\end{enumerate}

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/sd_reservation_request_allocation}
\caption{Interaction diagram depicting allocation of \gls{g:reservation} for a single \gls{g:reservation-request}}
\label{fig:sd_reservation_request_allocation}
\end{figure}

\begin{figure}[ht!]
\includegraphics[width=\textwidth]{diagrams/sd_reservation_request_set_allocation}
\caption{Interaction diagram depicting allocation of \glspl{g:reservation} for set of \glspl{g:reservation-request}}
\label{fig:sd_reservation_request_set_allocation}
\end{figure}

\todo{Describe that scheduler can in future use inter-controller protocol to allocate resources for reservations}
