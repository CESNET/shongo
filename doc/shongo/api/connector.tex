\chapter{Connector API Specification}

\input{commands}

\section{Communication Protocol}

\todo{Merge with XML-RPC description. Afterwards, just state, what is used for which communication acts (XML-RPC for user interface, Jade ontologies for Jade messaging). Use common failure codes. Groups of failure codes: Shongo-connections, connections between a connector and its device, failures reported by the devices themselves}

Communication among controllers and connectors is implemented using JADE \cite{jade}. The communication is \textbf{synchronous}, i.e., the controller sends a command to a connector and waits until the connector replies. The standard FIPA-Request \cite{FIPA-Request} interaction protocol: controllers send requests to perform an action, connectors receive the request, perform the action on the managed device, and send the result of the action as a reply to the controller.

All messages are encoded using the FIPA SL content language \cite{FIPA-SL}. An ontology, called \ApiCode{ShongoOntology}, is used by communicating agents to give the same meaning to the symbols used in messages. This section describes the way commands defined by this API are composed to messages and interpreted by Shongo agents.

The ontology used by all agents consists of concepts, predicates, and agent actions.
\begin{description}
\item[An agent action,] tagged by \ApiCode{jade.content.AgentAction} interface, expresses a request what should the receiving agent do. Each of the commands specified in this API document is defined by a class implementing \ApiCode{AgentAction}, declaring all the command arguments as attributes accessed by public getters and setters.
\item[A predicate,] tagged by \ApiCode{jade.content.Predicate} interface, expresses a claim about a fact. In Shongo, just the standard predicates from the FIPA-Request protocol are used for the purpose of expressing result of a command. We use no custom predicates.
\item[A concept,] tagged by \ApiCode{jade.content.Concept} interface, is any entity which may be a part of an agent action or a predicate. All object types of arguments or return values must be specified as concepts for the agent content manager to be able to properly encode them in messages. In particular, any such class must implement the \ApiCode{jade.content.Concept} interface and reside within the \ApiCode{cz.cesnet.shongo.jade.ontology} or \ApiCode{cz.cesnet.shongo.*.api} package for the \ApiCode{ShongoOntology} class to be able to find it and comprise it in the ontology used for encoding messages.
\end{description}


For example, the \ApiCode{setMicrophoneLevel(int level)} command, defined in section \ref{sect:connector-endpoint-api}, might be specified by the following class:
\begin{verbatim}
package cz.cesnet.shongo.jade.ontology;

public class SetMicrophoneLevel implements AgentAction {
    private int level = 0;

    public int getLevel() {
        return level;
    }
    public void setLevel(int level) {
        this.level = level;
    }
}
\end{verbatim}
The \ApiCode{setMicrophoneLevel} call implementation instantiates a new \ApiCode{SetMicrophoneLevel} object, sets up the \ApiCode{level} attribute, and passes the object to a controller agent content manager to send it to an endpoint as a \ApiCode{request} communicative act \cite{FIPA-ComActSpec}. The corresponding endpoint agent creates the \ApiCode{SetMicrophoneLevel} object received from the controller agent and implements the requested functionality according to it. The message sent during such a call might be similar to the following:
\begin{verbatim}
(REQUEST
 :sender  ( agent-identifier :name Controller@Shongo  :addresses (sequence
     http://127.0.0.1:7778/acc http://127.0.0.1:60273/acc ))
 :receiver  (set ( agent-identifier :name conn@Shongo ) )
 :content  "((action (agent-identifier :name Controller@Shongo :addresses
     (sequence http://127.0.0.1:7778/acc http://127.0.0.1:60273/acc))
     (SetMicrophoneLevel
 :level 50)))"
 :language  fipa-sl  :ontology  shongo-ontology  :protocol  fipa-request
)
\end{verbatim}

The agent receiving a command should always send a reply as an \ApiCode{inform} \cite{FIPA-ComActSpec} message. In case of commands without any return value, a \ApiCode{Done} predicate from the package \ApiCode{jade.content.onto.basic} should be sent as a reply, denoting a successful command execution. When a return value is expected, a \ApiCode{Result} predicate, defined in \cite{FIPA-SL}, is sent, filled with the value to be returned. The same requirements apply to the class of the object to be returned as for command object arguments -- the class must reside within the \ApiCode{cz.cesnet.shongo.jade.ontology} or \ApiCode{cz.cesnet.shongo.*.api} interface and be tagged by the \ApiCode{Concept} interface.

An example of a complex command is shown in appendix \ref{appendix:jade-command-encoding}.




\section{Data Types}

\begin{Api}

\ApiClass{ConnectorInfo}{}
Information about connector.
\begin{ApiClassAttributes}
\ApiClassAttribute{name}{String}{} the connector name
\ApiClassAttribute{device}{Resource}{} the device managed by this connector (must be a resource of type ManagedDevice -- see chapter \ref{sect:common:other})
\ApiClassAttribute{connectionState}{ConnectionState}{} connection state to the device
\ApiClassAttribute{deviceState}{DeviceState}{} state of the device, maintained by the connector for performance reasons
\end{ApiClassAttributes}

\ApiEnum{ConnectionState}
State of connection between a connector and a device it manages.
\begin{ApiEnumValues}
\ApiEnumValue{Connected}{}
\ApiEnumValue{Disconnected}{}
\end{ApiEnumValues}

\ApiClass{DeviceState}{}
State description of a device.
\todo{}

\ApiClass{DeviceLoadInfo}{}
Current device load information. A negative value in any attribute means the value could not be determined.
\begin{ApiClassAttributes}
\ApiClassAttribute{cpuLoad}{float}{}
\ApiClassAttribute{memoryOccupied}{long}{}
\ApiClassAttribute{memoryAvailable}{long}{}
\ApiClassAttribute{diskSpaceOccupied}{long}{}
\ApiClassAttribute{diskSpaceAvailable}{long}{}
\end{ApiClassAttributes}

\ApiClass{Room}{}
Represents a virtual room on a multipoint server device.
\begin{ApiClassAttributes}
\ApiClassAttributeCollection{users}{List}{RoomUser}{\ApiRequired} List of allowed users.
\ApiClassAttribute{allowGuests}{boolean}{\ApiRequired} A flag indicating whether to allow guest users to join the room.
\ApiClassAttribute{licenseCount}{int}{\ApiRequired} Number of licenses that multipoint server can utilize for this room.
\ApiClassAttribute{layout}{RoomLayout}{\ApiRequired} The default room layout (used for all participants who did not specify a layout of their own choice).
\ApiClassAttributeCollection{configuration}{List}{String}{\ApiOptional} Platform specific configuration.
\end{ApiClassAttributes}
\todo{Room settings should be auto-modified in time be uploaded calendar}

\ApiClass{UsageStats}{}
Usage stats of a given multipoint device.
\begin{ApiClassAttributes}
\ApiClassAttribute{callLog}{byte[]}{} Call log in CDR. Should contain at least start time and duration of each call.
\end{ApiClassAttributes}

\ApiClass{RoomInfo}{}
A brief info about a virtual room at a server.
\begin{ApiClassAttributes}
\ApiClassAttribute{name}{String}{\ApiRequired} Name of the room.
\ApiClassAttribute{owner}{String}{} Identification of the room owner.
\ApiClassAttribute{startTime}{DateTime}{} Date and time when the room was (or is to be) started.
\ApiClassAttribute{reservation}{Reservation}{} Reservation for which this room was created (to satisfy use-case \ref{UC:ops:room:shongo-options}).
\ApiClassAttribute{type}{Technology}{} Type of the room.
\end{ApiClassAttributes}

\ApiEnum{RoomLayout}{}
Layout of a virtual room.
\begin{ApiEnumValues}
\ApiEnumValue{SingleParticipant}{only a single, fixed participant is displayed}
\ApiEnumValue{VoiceSwitchedSingleParticipant}{only a single, currently speaking participant is displayed}
\ApiEnumValue{SpeakerCorner}{a fixed participant is in the upper-left corner, other participants around}
\ApiEnumValue{VoiceSwitchedSpeakerCorner}{the currently speaking participant is in the upper-left corner, other participants around}
\ApiEnumValue{Grid}{all participants are spread in a regular grid}
\end{ApiEnumValues}

\ApiClass{MediaData}{}
Custom media data, typically used for uploading or downloading some content (images, documents, etc.).
\begin{ApiClassAttributes}
\ApiClassAttribute{contentType}{ContentType}{\ApiRequired} Type of the data.
\ApiClassAttribute{data}{byte[]}{\ApiRequired} The content. To be interpreted according to the content type.
\ApiClassAttribute{compression}{CompressionAlgorithm}{\ApiOptional} Algorithm used to compress \ApiCode{data}.
\end{ApiClassAttributes}

\ApiClass{ContentType}{}
Description of a media type. Any MIME Media Type listed by IANA \cite{IANA-MediaTypes}, e.g. \texttt{image/jpeg}.
\begin{ApiClassAttributes}
\ApiClassAttribute{type}{String}{\ApiRequired} Textual name of the type (e.g., \ApiCode{image} or \ApiCode{text}).
\ApiClassAttribute{subtype}{String}{\ApiRequired} Textual name of the subtype (e.g., \ApiCode{jpeg} or \ApiCode{html}).
\end{ApiClassAttributes}

\ApiEnum{CompressionAlgorithm}{}
A compression algorithm used to compress data files.
\begin{ApiEnumValues}
\ApiEnumValue{ZIP}{zip compression, as specified by the \texttt{application/zip} MIME type}
\ApiEnumValue{RAR}{rar archive}
\ApiEnumValue{TAR_GZIP}{a gzip-compressed tar archive}
\ApiEnumValue{TAR_BZIP2}{a bzip2-compressed tar archive}
\end{ApiEnumValues}


\end{Api}


\section{Common API}

\begin{Api}

\ApiItem{\ApiCode{ConnectorInfo getConnectorInfo()}}
Get information about connector.

\ApiItem{\ApiCode{muteRoomUser(SecurityToken token, String RoomUserId)}}
Mutes a user in a room.

\ApiItem{\ApiCode{unmuteRoomUser(SecurityToken token, String RoomUserId)}}
Unmutes a user in a room.

\ApiItem{\ApiCode{setMicrophoneLevel(SecurityToken token, String RoomUserId, int level)}}
Sets microphone audio level of a user in a room to a given value. Note that the implementation differs between multipoint and endpoint types of devices. On an endpoint, the playback level is set using the device amplifier, while calling this on a multipoint device results in software adaptation of the output sound data (which may result in a distorted sound). The range for \ApiCode{level} is 0 to 100. The implementing connector adapts this value to the range for its managed device.

\ApiItem{\ApiCode{setPlaybackLevel(SecurityToken token, String RoomUserId, int level)}}
Sets playback audio level of a user in a room to a given value. Note that the implementation differs between multipoint and endpoint types of devices. On an endpoint, the playback level is set using the device amplifier, while calling this on a multipoint device results in software adaptation of the output sound data (which may result in a distorted sound). The range for \ApiCode{level} is 0 to 100. The implementing connector adapts this value to the range for its managed device.

\ApiItem{\ApiCode{enableUserVideo(SecurityToken token, String RoomUserId)}}
Enables video from a user in a room.

\ApiItem{\ApiCode{disableUserVideo(SecurityToken token, String RoomUserId)}}
Disables video from a user in a room.

\end{Api}

\section{Multipoint Device} \label{sect:connector-api-multipoint}

\subsection{Room Management}
\begin{Api}

\ApiItem{\ApiCode{RoomInfo getRoomInfo(SecurityToken token, String roomId)}}
Gets info about an existing room.

\ApiItem{\ApiCode{String createRoom(SecurityToken token, Room room)}}
Create a new virtual room on a multipoint device that is managed by this connector. The \ApiCode{room} parameter specifies the room settings, see the \ApiCode{Room} definition. Returns an identifier of the created room, unique within the device, to be used for further identification of the room as the \ApiCode{roomId} parameter.

\ApiItem{\ApiCode{modifyRoom(SecurityToken token, String roomId, Map attributes)}}
Modifies a room identified by \ApiCode{roomId}. The \ApiCode{attributes} map specifies \ApiCode{Room} attribute names mapped to new values.

\ApiItem{\ApiCode{deleteRoom(SecurityToken token, String roomId)}}
Delete an existing virtual room on a multipoint device that is managed by this connector.

\ApiItem{\ApiCode{String exportRoomSettings(SecurityToken token, String RoomId)}}
Gets current settings of a room exported to XML.
\\\todo{Specify schema of the exported XML document in RelaxNG. It should contain at least room name, technology (H.323/SIP/Connect\ldots) settings, and version of the format of the exported document (for further extensions).}

\ApiItem{\ApiCode{importRoomSettings(SecurityToken token, String RoomId, String settings)}}
Sets up a room according to given \ApiCode{settings} previously exported by the \ApiCode{exportRoomSettings} method.

\end{Api}


\subsection{User Management}
\begin{Api}

\ApiItem{\ApiCode{List<RoomUser> listRoomUsers(SecurityToken token, String roomId)}}

\ApiItem{\ApiCode{RoomUser getRoomUser(SecurityToken token, String roomId, String roomUserId)}}
Gets user information and settings in a room.

\ApiItem{\ApiCode{modifyRoomUser(SecurityToken token, String roomId, String roomUserId, Map attributes)}}
Modifies user settings in the room (suitable for setting
microphone/playback level, muting/unmuting, user layout\ldots).

\ApiItem{\ApiCode{disconnectRoomUser(SecurityToken token, String roomId, String roomUserId)}}
Disconnect user from the room.

\ApiItem{\ApiCode{enableContentProvider(SecurityToken token, String roomUserId)}}
Enables a given room user as a content provider in the room. This is typically enabled by default.

\ApiItem{\ApiCode{disableContentProvider(SecurityToken token, String roomUserId)}}
Disables a given room user as a content provider in the room. Typically, all users are allowed to fight for being the content provider. Using this method, a user is not allowed to do this.

\end{Api}


\subsection{Room Content Management}
\begin{Api}

\ApiItem{\ApiCode{MediaData getRoomContent(SecurityToken token, String roomId)}}
Gets all room content (e.g., documents, notes, polls, etc.) as a single archive (see the \ApiCode{compression} attribute of the returned object).

\ApiItem{\ApiCode{addRoomContent(SecurityToken token, String roomId, String name, MediaData data)}}
Adds a data file to room content under a given name.

\ApiItem{\ApiCode{removeRoomContentFile(SecurityToken token, String roomId, String name)}}
Removes a file of a given name from room content.

\ApiItem{\ApiCode{clearRoomContent(SecurityToken token, String roomId)}}
Clears all room content.

\end{Api}


\subsection{Monitoring}
\begin{Api}

\ApiItem{\ApiCode{DeviceLoadInfo getDeviceLoadInfo()}}
Gets info about current load of the device.

\ApiItem{\ApiCode{UsageStats getUsageStats()}}
Gets the multipoint usage stats.

\ApiItem{\ApiCode{RoomInfo[] getRoomList()}}
Gets a list of all rooms at a given server.

\ApiItem{\ApiCode{MediaData getReceivedVideoSnapshot(SecurityToken token, String RoomUserId)}}
Gets a snapshot of the video stream received by a user in a room. See the \ApiCode{contentType} of the returned object to get the image format returned.

\ApiItem{\ApiCode{MediaData getSentVideoSnapshot(SecurityToken token, String RoomUserId)}}
Gets a snapshot of the video stream that a user is sending in a room. See the \ApiCode{contentType} of the returned object to get the image format returned.

\end{Api}


\subsection{Recording}
\begin{Api}

\ApiItem{\ApiCode{int startRecording(SecurityToken token, String roomId, ContentType format, RoomLayout layout)}}
Immediately starts recording in a room to format \ApiCode{format} using a given \ApiCode{layout} (or the default room layout, if \ApiCode{layout} is not specified). Returns an identifier for further reference, unique among other recordings on the device. Does not have any effect and returns 0 if the room is already being recorded.

\ApiItem{\ApiCode{stopRecording(SecurityToken token, int recordingId)}}
Stops recording. The \ApiCode{recordingId} parameter, specifying what to stop, is an identifier previously returned by \ApiCode{startRecording}.

\ApiItem{\ApiCode{String getRecordingDownloadURL(SecurityToken token, int recordingId)}}
Returns a URL from where it is possible to download a recording. The \ApiCode{recordingId} parameter is an identifier previously returned by \ApiCode{startRecording}.

\ApiItem{\ApiCode{notifyParticipants(SecurityToken token, int recordingId)}}
Sends an e-mail to all non-anonymous participants present in the room recorded. Participants present in any moment of the recording must be notified, not just the registered users.

\ApiItem{\ApiCode{downloadRecording(SecurityToken token, String downloadURL, String targetPath)}}
Starts downloading a recording from \ApiCode{downloadURL}. The recording is stored on the server under \ApiCode{targetPath}.

\ApiItem{\ApiCode{deleteRecording(SecurityToken token, int recordingId)}}
Deletes a given recording. The \ApiCode{recordingId} parameter is an identifier previously returned by \ApiCode{startRecording}. If the recording is being worked with somehow (still being recorded, being uploaded, etc.), the operation is deferred to the moment when current operations are completed.

\end{Api}


\section{Endpoint Device} \label{sect:connector-endpoint-api}

\begin{Api}

\ApiItem{\ApiCode{dial(SecurityToken token, String server)}}
Dials a server.

\ApiItem{\ApiCode{resetDevice(SecurityToken token)}}
Resets the device.

\end{Api}


\section{Technology Specific API}
\todo{Cover use cases \ref{UC:ops:room:room-techspec} and \ref{UC:ops:room:user-techspec}.}
\\\todo{How to structure this section? List the supported commands for each technology separately, or list them on a single place, stating the technologies supporting a functionality for each command?}

\begin{Api}

\ApiItem{\ApiCode{dial(SecurityToken token, String deviceAddress)}}
Dials a device, multipoint or endpoint. Dialing a client is available only on \textbf{H.323} and \textbf{SIP}.

\end{Api}

