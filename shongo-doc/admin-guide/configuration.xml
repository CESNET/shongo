<?xml version="1.0" encoding="UTF-8"?>

<chapter>
<title>Configuration</title>

Each Shongo application can be configured by a XML configuration file. When a configuration file is modified the application
must be restarted to reload the changes. The configuration files must be located inside
<code>&lt;shongo&gt;/shongo-deployment/</code> directory, where <code>&lt;shongo&gt;</code> is the location where you installed
the Shongo (e.g., <code>/app/shongo</code>).



<!-- PostgreSQL database BEGIN -->
<beginpage/>
<section>
<title>PostgreSQL database</title>
<para>To configure PostgreSQL for Controller:</para>
<para>
Connect to PostgreSQL console (e.g., run <code>psql</code> command as <code>postgres</code> system user).
</para>
<para>
Create database for the Shongo:
<screen>
CREATE DATABASE shongo;
</screen>
</para>
<para>
Create user for Controller to connect to the database:
<screen>
CREATE USER shongo WITH PASSWORD '(password)';
</screen>
</para>
<para>
Change the database owner to the created user:
<screen>
ALTER DATABASE shongo OWNER TO shongo;
</screen>
</para>
<para>
Add the following lines to the configuration file <code>pg_hba.conf</code>:
<screen>
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
</screen>
The file may be located, e.g., in <code>/etc/postgresql/9.1/main/</code> (Debian) or in <code>/var/lib/pgsql/data/pg_hba.conf</code> (Fedora).
</para>
<para>
Then restart the PostgreSQL server:
<screen>
service postgresql restart
</screen>
</para>
</section>
<!-- PostgreSQL database END -->



<!-- shongo-controller BEGIN -->
<section>
<title>Controller</title>
<para>
    To configure Controller create configuration file <code>shongo-controller.cfg.xml</code>.
</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>
<configuration>
    ...
</configuration>
]]></screen>
</para>
<para>It can contain the following options:</para>
<itemizedlist>

<listitem>
<para><emphasis role="bold">Domain settings</emphasis></para>
<para>Configuration of domain. Each controller runs it's own domain.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>domain/name</code></term>
        <listitem><para>
            Specifies unique name of the domain (across all domains). It will be used in all object identifiers
            (e.g., domain name <code>meetings.cesnet.cz</code> will be used in identifier of a reservation request <code>shongo:meetings.cesnet.cz:req:1</code>).
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>domain/code</code></term>
        <listitem><para>
            Specifies shortcut of domain name and it doesn't have to be unique across domains.
            It will be used as prefix in email notifications (e.g., domain code <code>meetings</code> in email subject <code>[meetings] Notification ...</code>)
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>domain/organization</code></term>
        <listitem><para>
            Specifies name of the organization who owns the domain.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<domain>
    <name>meetings.cesnet.cz</name>
    <code>meetings</code>
    <organization>CESNET, z.s.p.o.</organization>
</domain>
        ]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Database settings</emphasis></para>
<para>Configuration of connection to database.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>database/driver</code></term>
        <listitem><para>
            Specifies name of Java class which implements the JDBC database driver.
            Currently the only valid value is <code>org.postgresql.Driver</code>.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>database/url</code></term>
        <listitem><para>
            Specifies connection string to database. The valid format is <code>jdbc:&lt;system&gt;:/&lt;host&gt;(:&lt;port&gt;)//&lt;database&gt;</code> where the <code>&lt;system&gt;</code> is name of database system (it shall be <code>postgresql</code>), the <code>&lt;host&gt;</code> and <code>&lt;port&gt;</code> are address of server and port number at which the database system is running and <code>&lt;database&gt;</code> is a name of database to use.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>database/username</code></term>
        <listitem><para>
            Specifies username which should be used when connecting to database.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>database/password</code></term>
        <listitem><para>
            Specifies password which should be used when connecting to database.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<database>
    <driver>org.postgresql.Driver</driver>
    <url>jdbc:postgresql://127.0.0.1/shongo</url>
    <username>shongo</username>
    <password>(password)</password>
</database>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Security settings</emphasis></para>
<para>Configuration of authentication and authorization.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>security/server</code></term>
        <listitem><para>
            Url to deployment of shongo authentication and authorization server where <code>&lt;url&gt;/authn/</code> and <code>&lt;url&gt;/perun/</code> endpoints are available (see AA documentation here <ulink url="https://github.com/shongo/shongo-auth-utils"><citetitle>https://github.com/shongo/shongo-auth-utils</citetitle></ulink>).
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>security/client-id</code></term>
        <listitem><para>
            Client identifier assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>security/client-secret</code></term>
        <listitem><para>
            Client secret assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/authorization/administrator</code></term>
        <listitem><para>
            <link linkend="authorization-expression">Authorization expression</link> for decision whether an user is system administrator (administrator can switch on the administration mode and see and modify all resources and reservations). If not set, the default expression <code>group("admins").contains(id)</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/authorization/operator</code></term>
        <listitem><para>
            <link linkend="authorization-expression">Authorization expression</link> for decision whether an user is system operator (operator can switch on the administration mode and see all resources and reservations). If not set, the default expression <code>group("operators").contains(id)</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/authorization/reservation</code></term>
        <listitem><para>
            <link linkend="authorization-expression">Authorization expression</link> for decision whether an user can create new reservation requests (users without permission to create new reservation requests can only see what other users share with them). If not set, the default expression <code>loa >= 2 || group("reservation").contains(id)</code> is used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<security>
    <server>https://shongo-auth.cesnet.cz</server>
    <client-id>meetings.cesnet.cz</client-id>
    <client-secret>(secret)</client-secret>
    <authorization>
        <administrator>group("admins").contains(id)</administrator>
        <operator>group("operators").contains(id)</operator>
        <reservation>loa >= 2 || group("reservation").contains(id)</reservation>
    </authorization>
</security>
]]></screen>
</para>
<para id="authorization-expression"><emphasis role="bold">Authorization Expressions</emphasis></para>
<para>
    Authorization expression is a short code in scripting language which must evaluate to <code>true</code> or <code>false</code> and the result stands for whether an user has or doesn't have a role or permission. In authorization expressions you can use the following statements:
<itemizedlist>
<listitem><code>id</code> - user-id</listitem>
<listitem><code>loa</code> - level of user authenticity</listitem>
<listitem><code>group("group-name").contains(id)</code> - evaluates to <code>true</code> when user is a member of group with given <code>group-name</code> and to <code>false</code> when he isn't.</listitem>
</itemizedlist>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Administrator settings</emphasis></para>
<para>Configuration of administrator email addresses where system errors will be send. System errors are unhandled exceptions and all other uncommon events. The notifications about reservations won't be sent to these email adresses.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>administrator</code></term>
        <listitem><para>
            Specifies one system administrator email address to receive system errors. If no option is set, no system errors will be reported by email and you must watch the application log files.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<administrator>martin.srom@cesnet.cz</administrator>
<administrator>pavelka@cesnet.cz</administrator>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Worker settings</emphasis></para>
<para>Worker settings can be used to specify how often the reservation scheduling should be performed. Scheduling loads reservation requests created by users and allocates reservations for them.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>worker/period</code></term>
        <listitem><para>
            Specifies how often the scheduling is performed. The allowed values are IS08601 durations. If not set, the default value <code>PT5S</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>worker/lookahead</code></term>
        <listitem><para>
            Specifies how far you want to schedule in future. The value <code>P7D</code> means that Scheduler will allocate only reservations a week ahead. If you create a request for reservation which takes place after 14 days from now, you will have to wait 7 days for the scheduler to allocate it. The allowed values are IS08601 durations. If not set, the default value <code>P31D</code> is used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<worker>
    <period>PT5S</period>
    <lookahead>P31D</lookahead>
</worker>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Executor settings</emphasis></para>
<para>Executor settings can be used to specify how the creation of virtual rooms will work.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>executor/period</code></term>
        <listitem><para>
            Specifies how often the execution is performed (i.e., how often the Controller database should be checked for executables to start/update/stop). The allowed values are IS08601 durations. If not set, the default value <code>PT15S</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>executor/executable/start</code></term>
        <listitem><para>
            Specifies how the starting date/time of virtual room should be modified. If you want to start the virtual room 30 seconds in advance before user specified date/time you should use <code>PT-30S</code> value. The allowed values are IS08601 durations. If not set, the default value <code>PT-30S</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>executor/executable/stop</code></term>
        <listitem><para>
            Specifies how the stopping date/time of virtual room should be modified. If you want to stop the virtual room 30 seconds in advance before user specified date/time you should use <code>PT-30S</code> value. The allowed values are IS08601 durations. If not set, the default value <code>PT-30S</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>executor/executable/next-attempt</code></term>
        <listitem><para>
            Specifies a duration to wait until next attempt of a failed execution action can take place (e.g., if a virtual room cannot be created because request to device timed out, this value specifies the duration to wait until next attempt will take place). The allowed values are IS08601 durations. If not set, the default value <code>PT2M</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>executor/executable/max-attempt-count</code></term>
        <listitem><para>
            Specifies the maximum number of starting/stopping attempts which should be tried before giving up. If not set, the default value <code>15</code> is used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<executor>
    <period>PT15S</period>
    <executable>
        <start>PT-30S</start>
        <end>PT-30S</end>
        <next-attempt>PT2M</next-attempt>
        <max-attempt-count>15</max-attempt-count>
    </executable>
</executor>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Reservation settings</emphasis></para>
<para>Reservation settings can be used to restrict the creation of new reservations.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>reservation/room/max-duration</code></term>
        <listitem><para>
            Specifies maximum duration of booked virtual room (e.g., adhoc-room or permanent room capacity). It does not restricts the duration of permanent rooms. If not set the default <code>P1W</code> maximum duration is used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<reservation>
    <room>        
        <max-duration>P1W</max-duration>
    </room>
</reservation>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Email notification settings</emphasis></para>
<para>Email notifications can contain links to reservation requests and configuration of user preferences (e.g., language or timezone). Email notifications are sent by the Controller and to let the Controller know where the a web interface is located you must use the following options.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>notification/reservation-request-url</code></term>
        <listitem><para>
            Specifies URL to be used in email notifications at which a reservation request can be viewed in a web browser. You should use a special variable <code>${reservationRequestId}</code> as placeholder for identifier of reservation request. If not set, the URLs to reservation requests won't be used in email notifications.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>notification/user-settings-url</code></term>
        <listitem><para>
            Specifies URL to be used in email notifications at which user can change his preferences (e.g., language or timezone). If not set, the URLs to user preferences won't be used in email notifications.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<notification>
    <reservation-request-url>
        https://meetings.cesnet.cz/detail/${reservationRequestId}
    </reservation-request-url>
    <user-settings-url>
        https://meetings.cesnet.cz/user/settings
    </user-settings-url>
</notification>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">SMTP settings</emphasis></para>
<para>Configuration of SMTP for sending email notifications. If not configured, no emails will be sent.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>smtp/sender</code></term>
        <listitem><para>
            Email address to be used as sender in all email notifications.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/host</code></term>
        <listitem><para>
            Address of SMTP server. 
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/port</code></term>
        <listitem><para>
            Port number of SMTP server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/username</code></term>
        <listitem><para>
            Username for authenticated SMTP server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/password</code></term>
        <listitem><para>
            Password for authenticated SMTP server.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<smtp>
    <sender>no-reply@meetings.cesnet.cz</sender>
    <host>rs.cesnet.cz</host>
</smtp>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">RPC and JADE settings</emphasis></para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>rpc/host</code></term>
        <listitem><para>
            Specifies on which host should the RPC listen.
            If not set, the RPC will listen on all hosts.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>rpc/port</code></term>
        <listitem><para>
            Specifies port on which the RPC will listen.
            If not set, the default port 8181 will be used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>rpc/ssl-key-store</code></term>
        <listitem><para>
            Specifies filename of Java KeyStore (JKS) with SSL certificate to use for secured XML-RPC. If not set the SSL is not used for XML-RPC.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>rpc/ssl-key-store-password</code></term>
        <listitem><para>
            Specifies password for JKS.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/host</code></term>
        <listitem><para>
            Specifies on which host should the JADE middleware listen.
            If not set, the JADE middleware will listen on 127.0.0.1.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/port</code></term>
        <listitem><para>
            Specifies port on which the JADE middleware will listen.
            If not set, the default port 8282 will be used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/agent-name</code></term>
        <listitem><para>
            Specifies JADE middleware agent name for Controller.
            If not set the default <code>Controller</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/platform-id</code></term>
        <listitem><para>
            Specifies JADE middleware platform identifier.
            If not set the default <code>Shongo</code> is used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<rpc>
    <host>127.0.0.1</host>
    <port>8181</port>
</rpc>

<jade>
    <host>127.0.0.1</host>
    <port>8282</port>
    <agent-name>Controller</agent-name>
    <platform-id>Shongo</platform-id>
</jade>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">SSL settings</emphasis></para>
<para>SSL settings can be used to turn off or alter hostname verification for specified hostnames.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>ssl/trusted-hostname</code></term>
        <listitem><para>
            Specifies hostname which should not be verified.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>ssl/mapped-hostname</code></term>
        <listitem><para>
            Specifies mapping from <code>source</code> hostname to <code>target</code> hostname for hostname verification.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<ssl>
    <mapped-hostname source="shongo-auth-dev.cesnet.cz" target="hroch.cesnet.cz"/>
    <trusted-hostname>shongo-auth.cesnet.cz</trusted-hostname>
</ssl>
]]></screen>
</para>
</listitem>

</itemizedlist>

<!-- shongo-controller EXAMPLE -->
<beginpage/>
<sect2>
<title>Complete example</title>
<para>Here is a minimal example of <code>shongo-controller.cfg.xml</code></para>
<screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>

<configuration>

    <domain>
        <name>meetings.cesnet.cz</name>
        <code>meetings</code>
        <organization>CESNET, z.s.p.o.</organization>
    </domain>

    <database>
        <driver>org.postgresql.Driver</driver>
        <url>jdbc:postgresql://127.0.0.1/shongo</url>
        <username>shongo</username>
        <password>(password)</password>
    </database>

    <security>
        <server>https://shongo-auth.cesnet.cz</server>
        <client-id>meetings.cesnet.cz</client-id>
        <client-secret>(secret)</client-secret>
    </security>

    <notification>
        <reservation-request-url>
            https://meetings.cesnet.cz/detail/${reservationRequestId}
        </reservation-request-url>
        <user-settings-url>
            https://meetings.cesnet.cz/user/settings
        </user-settings-url>
    </notification>

    <administrator>srom@cesnet.cz</administrator>
    <administrator>pavelka@cesnet.cz</administrator>

    <rpc>
        <ssl-key-store>keystore/server.keystore</ssl-key-store>
        <ssl-key-store-password>(password)</ssl-key-store-password>
    </rpc>

    <smtp>
        <sender>no-reply@meetings.cesnet.cz</sender>
        <host>rs.cesnet.cz</host>
    </smtp>

</configuration>
]]></screen>
</sect2>

</section>
<!-- shongo-controller END -->



<!-- shongo-connector BEGIN -->
<beginpage/>
<section>
<title>Connector</title>
<para>
    To configure Connector create configuration file <code>shongo-connector.cfg.xml</code>.
</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>
<configuration>
    ...
</configuration>
]]></screen>
</para>
<para>It can contain the following options:</para>
<itemizedlist>

<listitem>
<para><emphasis role="bold">Configuration of connector agents</emphasis></para>
<para>Allows you to configure agents to control device resources.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>connectors/connector</code></term>
        <listitem><para>
            Specifies an agent for controlling one device resource.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<connectors>

    <connector>
        <name>agent1</name>
        <class>(DeviceResourceClass)</class>
        ...
    </connector>

    <connector>
        <name>agent2</name>
        <class>(DeviceResourceClass)</class>
        ...
    </connector>

</connectors>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Controller and JADE settings</emphasis></para>
<para>Configuration of JADE middleware between Connector and Controller.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>controller/host</code></term>
        <listitem><para>
            Specifies on which host the Controller is running.
            If not set, the JADE middleware will try to connect to 127.0.0.1.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>controller/port</code></term>
        <listitem><para>
            Specifies on which port number the Controller is running.
            If not set, the JADE middleware will try to connect to 8282.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>controller/connection-check-period</code></term>
        <listitem><para>
            Specifies duration between connection attempts to Controller (when Connector gets disconnected). The allowed values are IS08601 durations. If not set the default value <code>PT10S</code> is used.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/host</code></term>
        <listitem><para>
            Specifies on which host should the JADE middleware listen.
            If not set, the JADE middleware will listen on 127.0.0.1.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>jade/port</code></term>
        <listitem><para>
            Specifies port on which the JADE middleware will listen.
            If not set, the default port 8383 will be used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<controller>
    <host>127.0.0.1</host>
    <port>8282</port>
    <connection-check-period>PT10S</connection-check-period>
</controller>

<jade>
    <host>127.0.0.1</host>
    <port>8383</port>
</jade>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">SSL settings</emphasis></para>
<para>SSL settings can be used to turn off or alter hostname verification for specified hostnames.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>ssl/trusted-hostname</code></term>
        <listitem><para>
            Specifies hostname which should not be verified.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>ssl/mapped-hostname</code></term>
        <listitem><para>
            Specifies mapping from <code>source</code> hostname to <code>target</code> hostname for hostname verification.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<ssl>
    <mapped-hostname source="shongo-auth-dev.cesnet.cz" target="hroch.cesnet.cz"/>
    <trusted-hostname>shongo-auth.cesnet.cz</trusted-hostname>
</ssl>
]]></screen>
</para>
</listitem>

</itemizedlist>

<!-- shongo-connector EXAMPLE -->
<beginpage/>
<sect2>
<title>Configuration of Adobe Connect connector</title>
<para>Configuration of connector agent for Adobe Connect server.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>class</code></term>
        <listitem><para>
            The value must be <code>AdobeConnectConnector</code>.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>TODO: the rest of options</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<connector>
    <name>connect</name>
    <class>AdobeConnectConnector</class>
    <host>connect.cesnet.cz</host>
    <port>443</port>
    <auth>
        <username>admin</username>
        <password>(password)</password>
    </auth>
    <options>
        <timeout>PT10S</timeout>
        <capacity-check-period>PT5M</capacity-check-period>
        <url-path-extraction-from-uri>
            connect\.cesnet\.cz/(.+)$
        </url-path-extraction-from-uri>
        <recordings-folder-name>shongo-rec</recordings-folder-name>
        <meetings-folder-name>shongo</meetings-folder-name>
        <recordings-check-period>PT5M</recordings-check-period>
        <recordings-prefix>rec_</recordings-prefix>
    </options>
</connector>
]]></screen>
</para>
</sect2>

<beginpage/>
<sect2>
<title>Configuration of Cisco MCU connector</title>
<para>Configuration of connector agent for Cisco MCU device.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>class</code></term>
        <listitem><para>
            The value must be <code>CiscoMCUConnector</code>.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>TODO: the rest of options</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<connector>
    <name>mcu</name>
    <class>CiscoMCUConnector</class>
    <host>mcuc.cesnet.cz</host>
    <port>443</port>
    <auth>
        <username>admin</username>
        <password>(password)</password>
    </auth>
    <options>
        <timeout>PT10S</timeout>
        <room-number-extraction-from-h323-number>
            (\d{3})$
        </room-number-extraction-from-h323-number>
        <room-number-extraction-from-sip-uri>
            ^[+\d]*(\d{3})@
        </room-number-extraction-from-sip-uri>
        <participants>
            <participant>
                <address>950084999</address>
                <hide>true</hide>
            </participant>
        </participants>
    </options>
</connector>
]]></screen>
</para>
</sect2>

<beginpage/>
<sect2>
<title>Configuration of Cisco TCS connector</title>
<para>Configuration of connector agent for Cisco TCS device.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>class</code></term>
        <listitem><para>
            The value must be <code>CiscoTCSConnector</code>.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>TODO: the rest of options</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<connector>
    <name>tcs</name>
    <class>CiscoTCSConnector</class>
    <host>rec1.cesnet.cz</host>
    <port>443</port>
    <auth>
        <username>admin</username>
        <password>(password)</password>
    </auth>
    <options>
        <default-bitrate>768</default-bitrate>
        <alias>999</alias>
        <storage>/media/meetings/storage</storage>
        <storage-permission>Require user ${userPrincipalName}</storage-permission>
        <metadata-storage>/media/shongo-dev/metadata</metadata-storage>
        <downloadable-url-base>https://meetings.cesnet.cz/tcs/</downloadable-url-base>
        <check-recordings-period>PT5M</check-recordings-period>
        <recordings-prefix>rec_</recordings-prefix>
    </options>
</connector>
]]></screen>
</para>
</sect2>

<beginpage/>
<sect2>
<title>Complete example</title>
<para>Here is a minimal example of <code>shongo-connector.cfg.xml</code> with one Adobe Connect agent and one Cisco MCU agent.</para>
<screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>

<configuration>

    <connectors>

        <connector>
            <name>connect</name>
            <class>AdobeConnectConnector</class>
            <host>connect.cesnet.cz</host>
            <port>443</port>
            <auth>
                <username>admin</username>
                <password>(password)</password>
            </auth>
            <options>
                <timeout>PT10S</timeout>
                <capacity-check-period>PT5M</capacity-check-period>
                <url-path-extraction-from-uri>
                    connect\.cesnet\.cz/(.+)$
                </url-path-extraction-from-uri>
                <recordings-folder-name>shongo-rec</recordings-folder-name>
                <meetings-folder-name>shongo</meetings-folder-name>
                <recordings-check-period>PT5M</recordings-check-period>
                <recordings-prefix>rec_</recordings-prefix>
            </options>
        </connector>

        <connector>
            <name>mcu</name>
            <class>CiscoMCUConnector</class>
            <host>mcuc.cesnet.cz</host>
            <port>443</port>
            <auth>
                <username>admin</username>
                <password>(password)</password>
            </auth>
            <options>
                <timeout>PT10S</timeout>
                <room-number-extraction-from-h323-number>
                    (\d{3})$
                </room-number-extraction-from-h323-number>
                <room-number-extraction-from-sip-uri>
                    ^[+\d]*(\d{3})@
                </room-number-extraction-from-sip-uri>
            </options>
        </connector>

    </connectors>

</configuration>
]]></screen>
</sect2>

</section>
<!-- shongo-connector END -->



<!-- shongo-client-web BEGIN -->
<beginpage/>
<section>
<title>Web Client</title>
<para>
    To configure Web Client create configuration file <code>shongo-client-web.cfg.xml</code>.
</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>
<configuration>
    ...
</configuration>
]]></screen>
</para>
<para>It can contain the following options:</para>
<itemizedlist>

<listitem>
<para><emphasis role="bold">Controller and web server settings</emphasis></para>
<para>Configuration of XML-RPC between Web-Client and Controller and configuration of web server.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>controller</code></term>
        <listitem><para>
            Specifies on which host and port number the Controller is running.
            If not set, the Web Client will try to connect to Controller XML-RPC at <code>127.0.0.1:8181</code>.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>server/port</code></term>
        <listitem><para>
            Specifies on which port number the web server will listen.
            If not set, the default port <code>80</code> will be used.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<controller>127.0.0.1:8181</controller>

<server>
    <port>80</port>
</server>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Security settings</emphasis></para>
<para>Configuration of user authentication.</para>
<variablelist>
    <varlistentry>
        <term>REQUIRED <code>security/server</code></term>
        <listitem><para>
            Url to deployment of shongo authentication and authorization server where <code>&lt;url&gt;/authn/</code> and <code>&lt;url&gt;/perun/</code> endpoints are available (see AA documentation here <ulink url="https://github.com/shongo/shongo-auth-utils"><citetitle>https://github.com/shongo/shongo-auth-utils</citetitle></ulink>).
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>security/client-id</code></term>
        <listitem><para>
            Client identifier assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>security/client-secret</code></term>
        <listitem><para>
            Client secret assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>security/redirect-uri</code></term>
        <listitem><para>
            Client redirect URI assigned by AA server.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<security>
    <server>https://shongo-auth.cesnet.cz</server>
    <client-id>meetings.cesnet.cz</client-id>
    <client-secret>(secret)</client-secret>
    <redirect-uri>http://meetings.cesnet.cz:8182/login</redirect-uri>
</security>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Design settings</emphasis></para>
<para>Configuration of custom design for Client Web.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>design/folder</code></term>
        <listitem><para>
            Specifies path to folder where a custom visual design for Client Web is stored. If not set the default value <code>(default)</code> is used and the Client Web will use the default visual design.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>REQUIRED <code>design/parameters</code></term>
        <listitem><para>
            Specifies paremeters for custom design.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<design>
    <folder>../shongo-domains/cesnet/shongo-client-web/design</folder>
    <parameters>
        <suggestion-email>vidcon@cesnet.cz</suggestion-email>
    </parameters>
</design>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">Administrator settings</emphasis></para>
<para>Configuration of administrator email addresses where web server errors will be send.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>administrator</code></term>
        <listitem><para>
            Specifies one administrator email address to receive web server errors. If no option is set, no web server errors will be reported by email and you must watch the application log files.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<administrator>martin.srom@cesnet.cz</administrator>
<administrator>pavelka@cesnet.cz</administrator>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">SMTP settings</emphasis></para>
<para>Configuration of SMTP for sending email error reports. If not configured, no emails will be sent.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>smtp/sender</code></term>
        <listitem><para>
            Email address to be used as sender in all email notifications.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/subject-prefix</code></term>
        <listitem><para>
            Prefix which should be used in subjects for all sent emails.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/host</code></term>
        <listitem><para>
            Address of SMTP server. 
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/port</code></term>
        <listitem><para>
            Port number of SMTP server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/username</code></term>
        <listitem><para>
            Username for authenticated SMTP server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>smtp/password</code></term>
        <listitem><para>
            Password for authenticated SMTP server.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<smtp>
    <sender>no-reply@meetings.cesnet.cz</sender>
    <subject-prefix xml:space="preserve">[meetings-web] </subject-prefix>        
    <host>rs.cesnet.cz</host>
</smtp>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">reCAPTCHA settings</emphasis></para>
<para><ulink url="https://www.google.com/recaptcha/admin"><citetitle>reCAPTCHA</citetitle></ulink> is used in Web Client when not-authenticated user wants to send a problem report - he is required to pass reCAPTCHA verification. It used only when both <code>recaptcha/public-key</code> and <code>recaptcha/private-key</code> are set.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>recaptcha/public-key</code></term>
        <listitem><para>
            Public key for reCAPTCHA (see reCAPTCHA documentation for further information).
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>recaptcha/private-key</code></term>
        <listitem><para>
            Private key for reCAPTCHA (see reCAPTCHA documentation for further information).
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<recaptcha>
    <public-key>(recaptcha-public-key)</public-key>
    <private-key>(recaptcha-private-key)</private-key>
</recaptcha>
]]></screen>
</para>
</listitem>

<listitem>
<para><emphasis role="bold">SSL settings</emphasis></para>
<para>SSL settings can be used to turn off or alter hostname verification for specified hostnames.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>ssl/trusted-hostname</code></term>
        <listitem><para>
            Specifies hostname which should not be verified.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>ssl/mapped-hostname</code></term>
        <listitem><para>
            Specifies mapping from <code>source</code> hostname to <code>target</code> hostname for hostname verification.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<ssl>
    <mapped-hostname source="shongo-auth-dev.cesnet.cz" target="hroch.cesnet.cz"/>
    <trusted-hostname>shongo-auth.cesnet.cz</trusted-hostname>
</ssl>
]]></screen>
</para>
</listitem>

</itemizedlist>

<!-- shongo-client-web EXAMPLE -->
<beginpage/>
<sect2>
<title>Complete example</title>
<para>Here is a minimal example of <code>shongo-client-web.cfg.xml</code></para>
<screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>

<configuration>

    <controller>127.0.0.1:8181</controller>

    <server>
        <port>80</port>
    </server>

    <security>
        <server>https://shongo-auth.cesnet.cz</server>
        <client-id>meetings.cesnet.cz</client-id>
        <client-secret>(secret)</client-secret>
        <redirect-uri>http://meetings.cesnet.cz:8182/login</redirect-uri>
    </security>

    <design>
        <folder>../shongo-domains/cesnet/shongo-client-web/design</folder>
        <parameters>
            <suggestion-email>vidcon@cesnet.cz</suggestion-email>
        </parameters>
    </design>

    <administrator>martin.srom@cesnet.cz</administrator>
    <administrator>pavelka@cesnet.cz</administrator>

    <smtp>
        <sender>no-reply@meetings.cesnet.cz</sender>
        <subject-prefix xml:space="preserve">[meetings-web] </subject-prefix>        
        <host>rs.cesnet.cz</host>
    </smtp>

    <recaptcha>
        <public-key>(recaptcha-public-key)</public-key>
        <private-key>(recaptcha-private-key)</private-key>
    </recaptcha>

</configuration>
]]></screen>
</sect2>

</section>
<!-- shongo-client-web END -->


<!-- shongo-client-cli BEGIN -->
<beginpage/>
<section>
<title>Command-Line Client</title>
<para>
    To configure Command-Line Client create configuration file <code>shongo-client-cli.cfg.xml</code>.
</para>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<?xml version="1.0" encoding="UTF-8" ?>
<configuration>
    ...
</configuration>
]]></screen>
</para>
<para>It can contain the following options:</para>
<itemizedlist>

<listitem>
<para><emphasis role="bold">Security settings</emphasis></para>
<para>Configuration of user authentication. Only needed if you want to authenticate regular user in Command-Line Client which is not common use case. If plan to use Commnad-Line client only with Shongo root user you don't have to fill these options.</para>
<variablelist>
    <varlistentry>
        <term>OPTIONAL <code>security/server</code></term>
        <listitem><para>
            Url to deployment of shongo authentication and authorization server where <code>&lt;url&gt;/authn/</code> and <code>&lt;url&gt;/perun/</code> endpoints are available (see AA documentation here <ulink url="https://github.com/shongo/shongo-auth-utils"><citetitle>https://github.com/shongo/shongo-auth-utils</citetitle></ulink>).
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/client-id</code></term>
        <listitem><para>
            Client identifier assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/client-secret</code></term>
        <listitem><para>
            Client secret assigned by AA server.
        </para></listitem>
    </varlistentry>
    <varlistentry>
        <term>OPTIONAL <code>security/redirect-uri</code></term>
        <listitem><para>
            Client redirect URI assigned by AA server.
        </para></listitem>
    </varlistentry>
</variablelist>
<para>
    <emphasis role="bold">Example:</emphasis>
    <screen><![CDATA[
<security>
    <server>https://shongo-auth.cesnet.cz</server>
    <client-id>client-cli</client-id>
    <client-secret>(secret)</client-secret>
    <redirect-uri>127.0.0.1</redirect-uri>
</security>
]]></screen>
</para>
</listitem>

</itemizedlist>

</section>
<!-- shongo-client-cli END -->



<!-- Java KeyStore BEGIN -->
<beginpage/>
<section>
<title>Java KeyStore</title>
<para>You can use the folowing commands to configure Java KeyStore.</para>
<para>
Listing certificates in JKS:
<screen>
keytool -keystore /usr/lib/jvm/java-6-oracle/jre/lib/security/cacerts \
        -storepass "changeit" -list  -v
</screen>
</para>
<para>
Add DER certificate to JKS:
<screen>
wget http://www.terena.org/activities/tcs/repository/TERENA_SSL_CA.der \
    &amp;&amp; keytool -keystore /usr/lib/jvm/java-6-oracle/jre/lib/security/cacerts \
               -storepass "changeit" -noprompt -import -alias "TERENA_SSL_CA" \
               -file TERENA_SSL_CA.der \
    ; rm TERENA_SSL_CA.der
</screen>
</para>
<para>
Add CRT certificate to JKS:
<screen>
echo -n | openssl s_client -connect rec1.cesnet.cz:443 \
        | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /tmp/host.crt \
    &amp;&amp; keytool -keystore /usr/lib/jvm/java-6-oracle/jre/lib/security/cacerts \
               -storepass "changeit" -noprompt -importcert -alias "rec1.cesnet.cz" \
               -file /tmp/host.crt \
    ; rm /tmp/host.crt
</screen>
</para>
<para>
Remove certificate from JKS:
<screen>
keytool -keystore /usr/lib/jvm/java-6-oracle/jre/lib/security/cacerts \
        -storepass "changeit" -noprompt -delete -alias "TERENA_SSL_CA"
</screen>
</para>
<para>
Run <code>java</code> with debug information about cerfificates:
<screen>
java -Djavax.net.debug=all
</screen>
</para>
<para>
Run <code>java</code> with custom JKS:
<screen>
java -Djavax.net.ssl.trustStore=&lt;keystore&gt;
</screen>
</para>
</section>
<!-- Java KeyStore END -->



<!-- Nagios NRPE plugin BEGIN -->
<beginpage/>
<section>
<title>Nagios NRPE plugin</title>
<para>
Configuration of Nagios NRPE plugin to watch <link linkend="shongo-controller">Controller</link>  and <link linkend="shongo-connector">Connector</link> agents.
</para>
<para>
You must install the <code>nagios-nrpe-server</code> on system where the Shongo is installed. On Debian you can use the following command.
<screen>
apt-get install nagios-nrpe-server
</screen>
</para>
<para>
Next you must allow your Nagios server to be able to access your machine where the Shongo is installed in NRPE configuration file. For example if your Nagios runs at <code>nagios.cesnet.cz</code> you must add it into variable <code>allowed_hosts</code> in configuration file <code>/etc/nagios/nrpe.cfg</code>:
<screen>
# ALLOWED HOST ADDRESSES
allowed_hosts=127.0.0.1,nagios.cesnet.cz
</screen>
</para>
<para>
Next you must define commands in configuration file <code>/etc/nagios/nrpe.cfg</code>. You should use <code>&lt;shongo&gt;/shongo-deployment/bin/shongo-check.sh</code> with argument <code>shongo-controller</code> or <code>shongo-connector &lt;agent-names&gt;</code> to check status of Controller or Connector agents accordingly.
<screen>
command[check_shongo_controller]=/app/shongo/shongo-deployment/bin/shongo-check.sh \
        -c https://meetings.cesnet.cz shongo-controller
command[check_shongo_connector]=/app/shongo/shongo-deployment/bin/shongo_check.sh \
        -c https://meetings.cesnet.cz shongo-connector connect1,mcu1
</screen>
</para>
<para>
The last step is to notify your Nagios administrator to configure Nagios to watch for your defined commands (<code>check_shongo_controller</code> and <code>check_shongo_connector</code>) on system where you installed the Shongo.
</para>
</section>
<!-- Nagios NRPE plugin END -->


</chapter>

